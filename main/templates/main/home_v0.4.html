<!-- datasets/home.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}

{% block title %}<title>WHGazetteer 0.3</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="{% static 'css/typeahead.css' %}">
  <script src="{% static 'js/leaflet.ajax.min.js' %}"></script>
  <script src="{% static 'js/typeahead.bundle.js' %}"></script>
{% endblock %}

{% block content %}
{% load static %}

<div class="container">
  <div class="justify-content-center mt-3">
    <div id="home_map">
      {% leaflet_map "map_home" callback="map_init" %}
    </div> <!-- map -->
    <div id="home_search">
      <div id="search_panel">
          <div id="search_type" class="form-group d-flex justify-content-center"> 
            <div class="form-check form-check-inline">
              <input class="form-check-input hover" type="radio" name="class" id="r_place" value="place" rel="Enter place name"  checked="checked">
              <label class="form-check-label" for="r_place">Places</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input hover" type="radio" name="class" id="r_trace" value="trace" rel="Enter term or name">
              <label class="form-check-label" for="r_trace">Traces
                  <span class="ml-1"><a href="" title="historical entities having spatial-temporal 'footprints'" rel="tooltip">{% fontawesome_icon 'question-circle' color='#336699' %}</a></span>                
              </label>
            </div>
          </div>          
          <div class="input-group input-group-sm mb-3">
            <div id="search_input">
              <input id="input_box" class="typeahead" type="text" placeholder="Enter place name">
            </div>
          </div>
        <div id="search_filters" class="hidden">searchfilters</div>
      </div>
      <!-- separate div for full search results -->
      <div id="result_list" class="hidden"></div>
    </div>
  </div>
</div>

<div id="ext_site" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
      </div>
      <div id="ext_content" class="modal-body">foo</div>
    </div>
  </div>
</div> <!-- ext_site -->
      

<script type="text/javascript">
  $(function(){
    $("#options").hide();
    var idToFeature = {} // for feature lookup
    var titles = {}
    var searchoption = null;
    clearit()
    //
    // data type choice determines index searched
    var suggester = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.whitespace,
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        remote: {
          wildcard: '%QUERY',
          url: 'foofah',
          prepare: function (query, settings) {
           var doctype = $("input[name='class']:checked").val();
           settings.url = '/search/search?doc_type='+doctype+'&scope=suggest&'+$.param({
                qstr: query
            });
           return settings;
         } 
        }
    });
    $('.typeahead').typeahead({minLength: 2,highlight:true}, {
        name: 'suggester',
        source: suggester,
        display: 'name',
        limit: 10,
        templates: {
          empty: [
            '<div class="small ml-2">','no results...','</div>'].join('\n'),
          suggestion: function (data) {
            doctype = $("input[name='class']:checked").val()
            console.log('doctype:',doctype)
            if(doctype == 'place'){
              return data.variants.length>0 ? '<p class="tight-p">' + data.name + '<br/><i class="tight-p">' + data.variants + '<i></p>' : '<p class="tight-p">' + data.name + '</p>'
            } else {
              <!--console.log(data)-->
              return '<p rel="'+data._id+'">'+data.title+'</p>'
            }
          }
        }
    }).on('typeahead:selected', function (obj, datum) {
      <!--console.log(datum)-->
      if(doctype=='trace'){
        fetchTraceGeom(datum._id,0,datum.title)
      }
    });
  })
  //
  // future advanced options
  <!--$("#options_link").on("click", function(e){-->
    <!--e.preventDefault()-->
    <!--$("#options").toggle()-->
    <!--$("#options_link").toggle()-->
  <!--})-->
  $('input[type=radio][name=class]').change(function() {
    <!--$("#options_link").show()-->
    <!--$("#options").hide()-->
    <!--$(".autosuggest").html('')-->
    $('#input_box').val('')
    $('#input_box').attr("placeholder",this.getAttribute("rel"));
  });
  // initiates map
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
    mappy.setMaxBounds(null)
    var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      attrib_awmc = 'Tiles and Data &copy; 2013 <a href="http://www.awmc.unc.edu" target="_blank">AWMC</a>',
      token_mb = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
      token_kg = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiUmVralBPcyJ9.mJegAI1R6KR21x_CVVTlqw',
      token_awmc = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiY2prcmgwc2cwMjRuZzNsdGhzZmVuMDRqbCJ9.MeLsyeOqwhTRdvt_Hgo7kg',
      token_whg = '',
      mbtiles_url = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}';
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var awmc = L.tileLayer(mbtiles_url, {id:'isawnyu.map-knmctlkh', token:token_awmc, attribution:attrib_awmc}),
      grayscale = L.tileLayer(mbstyle_url, {id:'kgeographer/cjstfpenh6o1e1fldz95w8m6p', token:token_kg, attribution:attrib_mb}),
      satellite  = L.tileLayer(mbtiles_url, {id:'mapbox.satellite', token:token_mb, attribution:attrib_mb});
      osm  = L.tileLayer(mbtiles_url, {id:'mapbox.light', token:token_mb, attribution:attrib_mb});

    var countryStyle = {
      "color": "#ddd",
      "weight": 1,
      "opacity": 0.5,
      "fillOpacity": 0
    };

    var countries = new L.GeoJSON.AJAX("/media/data/countries_simplified.json",
      {style:countryStyle,
        onEachFeature: function (feature, layer) {
          popupOptions = {maxWidth: 200};
            layer.bindPopup(feature.properties.gnlabel, popupOptions);
          }
    });

    var baseLayers = {
      "AWMC Terrain": awmc,
      "OSM": osm,      
      "Spine Data": grayscale,
      "Satellite": satellite
    };
    var dataLayers = {
      "Countries": countries
    }
    mappy.zoomControl.setPosition('topright')
    L.control.layers(baseLayers,dataLayers).addTo(mappy);
    baseLayers["AWMC Terrain"].addTo(mappy)
    dataLayers["Countries"].addTo(mappy)
  }, false);

  function map_init (home_map, options) {
    <!--console.log(options)-->
    mappy.setView([38, 10], 2.4)
    <!--mappy.zoomControl.setPosition('topright')-->
    <!--new L.Control.Zoom({ position: 'topleft' }).addTo(map);-->
    // empty features[]
    geom = {"type":"FeatureCollecton","features":[]}

  } // end map_init
  
  function filly(counter) {
    if (counter == 0)
      return "blue"
    else if (counter == 1)
      return "orange"
    else if (counter == 2)
      return "purple"
    else if (counter == 3)
      return "greenyellow"
    else 
      return "yellow"
  }

  function fetchTraceGeom(trace_id,counter,title) {
    <!--console.log('fetchTraceGeom():',trace_id)-->
    if(typeof(traces) !== "undefined") {traces.clearLayers();}
    $.get("/search/tracegeom",{idx: 'traces', search: trace_id, doc_type: 'trace'},
      function(data){
        <!--console.log('bodies in this trace',data.bodies)-->
        showResults(data.bodies,'trace','suggest',title)
        var count_features = 0
        idToFeature = {}
        mappy.createPane('tracePane');
        mappy.getPane('tracePane').style.zIndex = 200;
        traces = L.geoJSON(data, {
          pane: 'tracePane',
          pointToLayer: function (feature, latlng) {
            count_features +=1;
            identifier = feature.properties.whg_id;
            <!--console.log(feature,identifier)-->
            marker = L.circleMarker(latlng,
              {
                radius: 5, fillOpacity: 0.8, opacity: 1, weight: 1,
                color: "#fff", fillColor: filly(counter)
              }
            ).bindPopup('whg:'+identifier+'<br/><b>'+
              '<a href="/places/'+identifier+'/portal">'+feature.properties.title+"</b></a>");
            
            <!--marker.on('mouseover', function (e) {-->
                <!--this.openPopup();-->
            <!--});-->
            <!--marker.on('mouseout', function (e) {-->
                <!--this.closePopup();-->
            <!--});-->
            
            idToFeature[identifier] = marker
            return marker
          }
        }).addTo(mappy);
        bounds = traces.getBounds()
        if (bounds.getSouthWest().equals(bounds.getNorthEast())) {
          // single point
          mappy.setView(bounds.getCenter(),5)
        } else {
          mappy.fitBounds(bounds)
        }
    });
  }

  // clear any results
  clearit = function(){
    $("#search_input").val('')
    $("#result_list").html('')
    $("#result_list").hide()
  }  
  //
  // catch Enter key press for places, trigger button
  // traces are handled in core typeahead function
  $(".typeahead").on('keyup', function(e){
    if (e.keyCode === 13 && doctype == 'place') {
      searchPlaces()
    } 
  })

  $("#search_input").on('click','.tt-selectable', function(e) {
    if(doctype == 'place') {
      console.log('clicked place suggestion',$(this))
      searchPlaces()    
    } else if(doctype == 'trace') {
      console.log('title:',$(this).text())
      fetchTraceGeom($(this).attr('rel'),0,$(this).text())
    }
  })
  //
  // perform search, not autocomplete
  searchPlaces = function (){
    scope = 'search'
    window.doctype = $("input[name='class']:checked").val();
    $.get("/search/search",{
        qstr: $(".tt-input")[0].value, 
        doc_type: doctype,
        scope: scope
      }, function(data){
        // render to html
        showResults(data,doctype,scope);
    });
    $('.tt-menu').hide()
  }

  styles = {
    'place_default': {
      radius: 7, fillOpacity: 0.6, opacity: 1, weight: 1,
      color: "#fff", fillColor: "red"
    },
    'place_highlight': {
      radius:10,fillOpacity:1,fillColor:"yellow",color:"#000"
    }
  }
  //
  // fetch geometries for search results
  renderPlaces = function(geoms) {
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
      mappy.setView([35.0, 13.0], 1)
    }
    data = {"type":"FeatureCollection","features":geoms}
    <!--console.log(data)-->
    var count_features = 0
    idToFeature = {}
    mappy.createPane('placePane');
    mappy.getPane('placePane').style.zIndex = 200;
    features = L.geoJSON(data, {
      pane: 'placePane',
      pointToLayer: function (feature, latlng) {
        count_features +=1;
        <!--identifier = feature.properties.pid;-->
        identifier = feature.properties.whgid;
        marker = L.circleMarker(latlng, styles.place_default
        ).bindPopup(feature.properties.title+' (whg id:'+identifier+')');
        // add to array for selection
        idToFeature[identifier] = marker
        return marker
      }
    }).addTo(mappy);
    bounds = features.getBounds()
    <!--mappy.setView(bounds.getCenter(),5) -->
    if(geoms.length > 0 ){
      <!--mappy.fitBounds(bounds)  -->
      mappy.setView(bounds.getCenter(),)
    }
  }
  
  function showResults(data,doctype,scope='suggest',title){
    console.log('showResults(data,doctype,scope):',data)
    var results_div = '';
    geoms=[]
    
    data.forEach(function(sug){
      <!--supply name for popup, places only-->
      if(!!sug.geom) {
        sug.geom.forEach(function(g){
          g['properties']['title']=sug.name
          g['properties']['whgid']=sug.whg_id
          geoms.push(g)
        })
      }
      // build results div
      results_div += sugLister(sug,doctype,scope)
    });
    
    if(scope=='search') {
      <!--console.log(geoms)-->
      renderPlaces(geoms)
    }
     
    $('#result_list').show()
    titleMarkup = doctype=='trace'?'<p class="pl-1 mb-1 small strong">'+title+'</p>':''
    $('#result_list').html(titleMarkup+
      "<p class='half allcap-heading mb-0 pl-1'>"+(doctype=='place'?'SEARCH RESULTS ('+data.length+')':
      'PLACES  ('+data.length+')')+'</p>'
      +results_div
    );    

    // empty the typeahead suggestions
    $(".tt-dataset").html('')
    
    // highlight map marker from list
    <!--$("li.body-place").on('click',function(e){-->
    $(".trace-item").on('click',function(e){
      // reset all markers to default
      traces.setStyle({"fillColor":"blue","radius":5})
      whgid = $(this).attr('data-id')
      console.log(whgid,'from body-place click')
      if(whgid in idToFeature) {
        idToFeature[whgid].setStyle({"fillColor":"#ff3333","radius":10})
        mappy.panTo(idToFeature[whgid]._latlng)
      } else {
        h = $(this).html()
        h += '...<b>no geometry yet</b>'
        $(this).html(h)
      }
    })
    
    $(".search-row").on('click',function(e){
      features.setStyle(styles.place_default)
      whgid = $(this).attr('data-id')
      idToFeature[whgid].setStyle(styles.place_highlight)
      mappy.panTo(idToFeature[whgid]._latlng)
    })
    // open a modal for external page
    $('.ext').on('click', function(e) {
      e.preventDefault();
      var url = $(this).attr('href');
      console.log('url',url)
      $(".modal-body").html('<iframe width="100%" height="100%" frameborder="0" scrolling="yes" '+
        'allowtransparency="true" src="'+url+'"></iframe>');
    });
  }
  
  // load place portal page from results_list item title links       
  // TODO: links are nested so click produces 2 events
  $("#result_list").on('click', '.trace-link', function(e){
    whgid=$(this).data('id')
    console.log('clicked .xxxxx-item',$(this))
    location.href = 'places/'+whgid+'/portal'
  });
  $("#result_list").on('click', '.place-link', function(e){
    whgid=$(this).data('id')
    console.log('clicked .xxxxx-item',$(this))
    location.href = 'places/'+whgid+'/portal'
  });
        

  // TODO: this doesn't reach into when.timespans; Indias data malformed
  function parseWhen(when){
    html=''
    for (w in when){
      s = 'start' in when[w]?'start: '+when[w]['start']:'earliest: '+when[w]['earliest']
      e = 'end' in when[w]?'end: '+when[w]['end']:'latest: '+when[w]['latest']
      html += s +", " +e
      html+=w==when.length-1?'':'; '
    }
    return html
  }
  function placeList(bods) {
    html='<ul class="small">'
    for (b in bods){
      if(bods[b]['whg_id'] !=null){
        <!--console.log(bods[b])-->
        html+='<li class="body-place" data-id="'+bods[b]['whg_id']+'">'+bods[b]['title']+' ('+bods[b]['relation']+')<br/>'
        html+='when' in bods[b] ? '<span class="mt-0"><i>'+parseWhen(bods[b]['when'])+'</i></span>' : ''
        html+='</li>'
      }
    }
    html += '</ul>'
    return html
  }
  function sugLister(sug,doctype,scope) {
    <!--console.log(sug)-->
    if (doctype=='place') {
      variants = sug['variants'].length > 0 ? '<br/><i class="text-secondary"> var: '+sug['variants']+'; </i>' : ''
      if (scope=='search'){
        snippet = sug['snippet'].length > 0 ? sug['snippet']+'...' : ''
        ccodes = sug['ccodes'].length > 0 ? ' ['+sug['ccodes']+']' : ''
        types = ' ('+sug['types']+')'
        geo = sug['geom'].length > 0 ? ' {% fontawesome_icon 'globe' color='#666' %}' : ''
        item = '<div class="search-row place-item" data-id="'+sug['whg_id']+
          '"><a class="place-link" href="#" data-id="'+sug['whg_id']+'"><b>'+
          sug['name']+'</b></a>'+types+ccodes+geo+variants+
          '<br/>'+snippet+'</div>'
      } else {
        item = '<div class="sug_row sug-item">'+sug['name']+' '+variants+'</div>'
      }
    } else if (doctype=='trace') {
      // sug is a trace body (place) here 
      <!--console.log(sug)-->
      item =  ('<div class="container"><div class="row sug_row trace-item" data-id='+sug['whg_id']+'>'+
              '<div class="col-sm-9 pl-0"><a href="#" class="trace-link" data-id="'+sug['whg_id']+'">'+
              sug['title']+'</a> ('+sug['relation']+')')
      if ("when" in sug) {
        item += '<br/><span class="mt-0"><i>'+parseWhen(sug['when'])+'</i></span>'
      }
      item += '</div><div class="col-sm-3"></div>'
      if("depiction" in sug){
        item += '<div class="trace_detail"><img class="trace-img" src="'+sug['depiction']+'"/></div>'
      }
      item += '</div></div>' // trace-item, container
    }
    return item
  }
<!--<span class="float-right">'+-->
                <!--'<a class="mr-2 ext" data-toggle="modal" data-target="#ext_site" href="'+sug['id']+-->
                <!--'">{% fontawesome_icon 'external-link' color='#336699' %}</a>'+-->
              <!--'</span>-->
              
  $("[rel='tooltip']").tooltip();
  $('label.btn').click(function(){
    $(".autosuggest").html('')
    $('#search_input').val('')
    $('#search_input').attr("placeholder",this.getAttribute("rel"));
  })
</script>
{% endblock %}
