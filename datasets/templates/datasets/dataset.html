{% extends "main/base.html" %}

{% load static %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load mathfilters %}
{% load dataset_extras %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <script src="{% static 'js/easyprint.js' %}"></script>
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <script src="{% static 'js/spin.umd.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
{% endblock %}

{% block content %}
<div id="dataset_content" class="container mt-1 px-1">
  <!-- Title + nav tabs -->
  <ul class="nav nav-tabs" id="dataset_tabs" role="tablist">
    <span class="ds-title h5 text-secondary ml-1 mr-3">{{ object.name }}</span>
    <li class="nav-item">
      <a class="nav-link active" id="summary-tab" data-toggle="tab" href="#summary" role="tab" aria-controls="home" aria-selected="true">Metadata</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="browse-tab" data-toggle="tab" href="#browse" role="tab" aria-controls="profile" aria-selected="false">Browse</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="reconciliation-tab" data-toggle="tab" href="#reconciliation" role="tab" aria-controls="profile" aria-selected="false">Reconciliation</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="sharing-tab" data-toggle="tab" href="#sharing" role="tab" aria-controls="messages" aria-selected="false">Sharing</a>
    </li>
    <li class="nav-item hidden">
      <a class="nav-link" id="addtask-tab" data-toggle="tab" href="#addtask" role="tab" aria-controls="profile" aria-selected="false">Add task</a>
    </li>
  </ul>
  <!-- Tab panes -->
  <div class="tab-content">
    <div class="tab-pane active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
      <form id="ds_form" method="POST" action="#" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
      <div id="ds_details" class="col-sm-7 small">
        <p><b>Name</b>: 
          <span class="form-name bigger strong text-danger">{{ object.name }}</span>
          <span class="hidden editing-name">{{ form.name }}</span>
          &nbsp;<span class="edit-name small"><a href="#">{% fontawesome_icon 'edit' color='#336699' %}</a></span>
        </p>
        <p><b>Description</b>: 
          <span class="form-description">{{ object.description }}</span>
          <span class="hidden editing-description">{{ form.description }}</span>
          &nbsp;<span class="edit-description small"><a href="#">{% fontawesome_icon 'edit' color='#336699' %}</a></span>
        </p>
        <p><b>IDs</b> (label/number): 
          <span class="text-danger">{{ object.label }}</span>/<span class="text-danger">{{ object.id }}</span>
        </p>
        <p><b>File</b>: {{ object.file }}</p>
        <p><b>Date</b>: {{ object.upload_date|date:"d-M-Y, H:i (e)" }}</p>
        <p><b>Total rows</b>: {{ object.numrows }}</p>
        <p><b>Data type</b>: {{ object.datatype }}</p>
        <p><b>URI base</b>: {{ object.uri_base }}</p>
        <p><b>Format</b>: {{ object.format }} ({{ object.delimiter }})</p>
        {% if object.mapbox_id %}
          <p class="form-value"><b>MapBox ID</b>: {{ object.mapbox_id }}</p>
          <p class="hidden editing"><b>MapBox ID</b>: {{ form.mapbox_id }}</p>
        {% endif %}
        <p><b>Status</b>: {{ object.status }}</p>
        <p><b>Columns</b>: {{ object.header }}</p>
        <input class="btn btn-primary hidden" type="submit" value="Save" />
      </div>
      <div id="ds_stats" class="col-sm-5 small">
        <h5 class="text-secondary">Counts <small>( initial, <span class="bg-danger text-white small">&nbsp;added </span>&nbsp;)</small></h5>
        <p><b>Names</b>: {{ num_names }}</p>
        <p><b>Links</b>:
          {{ num_links }}, <span class="text-white bg-danger">&nbsp;{{ links_added }}&nbsp;</span></p>
        <p><b>Geometries</b>: {{ num_geoms }}, <span class="text-white bg-danger">&nbsp;{{ geoms_added }}&nbsp;</span>        
      </div>
      </div> <!-- row -->
      </form>
    </div>
    <div id="browse" class="tab-pane" role="tabpanel" aria-labelledby="browse-tab">
    
    
<div class="container">
  <!--<h4 class="mt-3">{ ds.name }}-->
    <!--<span class="small text-muted">("{{ object.label }}")-->
      <!--<a href="{ url 'datasets:dataset-detail' object.id %}" title="Dataset portal" rel="tooltip"-->
        <!--class="small">{ fontawesome_icon 'cog' color='#336699' %} dataset portal</a>-->
    <!--</span><span class="toomany small text-danger ml-3"></span>-->
    <!--<span id="feature_count" class="half float-right"></span>-->
  <!--</h4>-->
  <div class="container mt-3">
    <div class="row">
      <div id="drftable_detail" class="col-sm-6 pl-0">
        <div id="drftable_title"></div>
        <div id="map">
            {% leaflet_map "map" callback="map_init" %}
            <div class="spinner-border text-danger"></div>
        </div>
        <!-- row detail in 2 columns by getPlace() -->
        <div id="row_detail" class="row">
          <div id="detail_left" class="small col-sm-6">
            <p class="text-center mt-5">
              <!--<img src="{# static 'images/ajax-loader.gif' #}" />-->
            </p>
          </div>
          <div id="detail_right" class="small col-sm-6">
            <p>right side</p>
          </div>
        </div>
      </div>
      <div id="drftable_list" class="col-sm-6">
        <table id="placetable" class="table table-striped table-bordered" style="width:100%">
          <thead>
            <tr>
              <th>pid</th>
              <th>src_id</th>
              <th>title</th>
              <th>ccodes</th>
              <!--<th>geo</th>-->
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div> <!-- browse -->
<div id="ext_site" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
      </div>
      <div id="ext_content" class="modal-body">foo</div>
    </div>
  </div>
</div> <!-- ext_site -->
<!--

-->
    </div>
    <div class="tab-pane" id="reconciliation" role="tabpanel" aria-labelledby="reconciliation-tab">
      <div id="ds_tasks" class="small">
        <h6 class="">Reconciliation Tasks 
          <span class="small help-matches" data-id="reconciliation">
            {% fontawesome_icon 'question-circle' color='#993333' %}</span>
          {% if object.owner.id == user.id or user.is_superuser %}
          <span class="float-right half"><a href="{% url 'datasets:dataset_recon' object.id %}" class="ml-5">
            add task {% fontawesome_icon 'plus-square' color='#336699' %}</a></span>{% endif %}
        </h6>
        {% if object.owner.id == user.id or user.is_superuser or user in users %}
        {% for t in tasks %}
        <div class="task-box">
          <!-- TODO: display bounds used if any -->
          <!--{ t.task_kwargs|parsejson:"bounds" }}-->
          <div class="row">
            <div class="col-sm-9">
              <p><b>Task</b>: {{ t.task_name }} <span class="small">
                ({{ t.date_done|date:"d-M-Y, H:i (e)" }}; elapsed: {{ t.result|get:"elapsed"|safe }})</span>
              </p>
              <p><b>ID</b>: {{ t.task_id }}</p>
                 <!-- TODO: confirm, select which to delete -->
              {{ t.result.hits }}
              <p><b>Result</b>: {{ t.result|get:"got_hits"|safe }} records (of
                  {{ t.result|get:"count"|safe }}) got total of <b>{{ t.result|get:"total"|safe }}</b> hits</p>
              <p id="latest"></p>
              <ul>
                <li><i>Pass 1</i>
                  {% if t.result|get:"pass1" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_1'>nn</span> 
                  <a href="{% url 'datasets:review' pk=object.id tid=t.task_id passnum='pass1' %}">
                   review</i></a>{% endif %}
                </li>
                <li><i>Pass 2</i>
                  {% if t.result|get:"pass2" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_2'>nn</span> 
                  <a href="{% url 'datasets:review' pk=object.id tid=t.task_id passnum='pass2' %}">
                   review</i></a>{% endif %}
                </li>
                {% if t.task_name != 'align_wd' %}
                <li><i>Pass 3</i>
                  {% if t.result|get:"pass3" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_3'>nn</span> 
                  <a href="{% url 'datasets:review' pk=object.id tid=t.task_id passnum='pass3' %}">
                   review</i></a>{% endif %}
                </li>
                {% endif %}
              </ul>
              <!--{# if user.is_superuser %}-->
              <p class="small">
                 <a class="confirm-del-all" data-id={{t.task_id}} href="{% url 'datasets:task-delete' tid=t.task_id scope='task' %}">
                   Delete task & hits, clear matches {% fontawesome_icon 'trash' color='#ff0000' %}</a><br/>
                   <a class="confirm-del-geoms" href="{% url 'datasets:task-delete' tid=t.task_id scope='geoms'%}">
                  Delete geometries added so far</a>
              </p>
              <!--{# endif %}-->
            </div>
            <div class="col-sm-3">
              {% if t.task_name == 'align_wd' %}
                <img src="{% static 'images/Wikidata-logo-en.svg'%}" width="80"/>
              {% elif t.task_name == 'align_tgn' %}
                <img src="{% static 'images/getty80.png'%}" />
              {% elif t.task_name == 'align_whg' %}
                <img src="{% static 'images/whg_accessioning.svg'%}" width="80"/>
              {% endif %}
            </div>
          </div> <!-- row -->
        </div> <!-- task-box -->
        {% endfor %}
        {% endif %}
      </div>
    </div>
    <div class="tab-pane" id="sharing" role="tabpanel" aria-labelledby="sharing-tab">
      <form id="sharing_form" method="POST" action="{% url 'datasets:collab-add' dsid=object.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <h5 class="text-secondary">Sharing</h5>
      <div class="sharing-box mb-3">
        <div class="sharing-header">Collaborators
          {% if object.owner.id == user.id or user.is_superuser %}
          <!--<span class="float-right small mr-2">-->
          <span class="sharing-input float-right input-group">
            <input type="text" class="form-control input-sm" name="username" placeholder="Enter username">
            <div class="input-group-append">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Add</button>
            </div>
          </span>
          {% endif %}
        </div>
        <ul id="collabs_list">
          {% for c in collab %}<li>{{ c.user }} ({{ c.role }})
          {% if object.owner.id == user.id or user.is_superuser %}
          <span class="float-right mr-2">
            <a href="{% url 'datasets:collab-delete' uid=c.id dsid=object.id %}">
            {%fontawesome_icon 'times-circle' color='#336699'%}</a>
          </span>{% endif %}
          </li>{% endfor %}
        </ul>
        {% if messages %}{% for message in messages %}
          <i style="display:block;" class="text-danger ml-4 mb-2">{{ message }}</i>
        {%endfor%}{% endif %}            
      </div>
      </form>
    </div>
    <div class="tab-pane" id="addtask" role="tabpanel" aria-labelledby="profile-tab"><h5>Add task</h5></div>
  </div>
</div>

<script type="text/javascript">
  $(function(){
    <!--$("html,body").scrollTop(0);-->
    // Javascript to enable link to tab
    var url = document.location.toString();
    if (url.match('#')) {
      tab = url.split('#')[1]
      $('.nav-tabs a[href="#' + tab+ '"]').tab('show');
    } 
    // Change hash for page-reload
    $('.nav-tabs a').on('shown.bs.tab', function (e) {
      console.log('e.target.hash',e.target.hash)
      if(!(e.target.hash=="#summary")){
        window.location.hash = e.target.hash;
      } else {
        window.location.hash = '';
        <!--console.log('clicked summary tab')-->
      }
      if(e.target.hash=="#reconciliation"){
        updateTotals('{{ object.id }}')
      }
    })
    
    // TODO: reload should NOT be necessary
    <!--location.reload();-->
    console.log('dataset id: {{ object.id }}')
    updateTotals('{{ object.id }}')
    steps={"uploaded":1,"reconciling":2,"review_hits":3,"reviewed":4,"review_whg":5,"indexed":6}
    $("[ref="+steps['{{ object.status }}']+"]").addClass('prog-active')

    $("#collabs_list a").click(function(){
      console.log($(this).data('uid'))
    })   
    $(".help-matches").click(function(){
      page=$(this).data('id')
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: 600,
      width: 700,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {$(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html');
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });
  })
  function updateTotals(dsid){
    $.get("/search/updatecounts",{ds_id: dsid},
      function(data){
        updates=data
        console.log('fired updateTotals()',updates, dsid)
        for(u in updates){
          html1='';html2='';html3='';
          <!--console.log(updates[u])-->
          html1+=updates[u]['pass1']
          html2+=updates[u]['pass2']
          html3+=updates[u]['pass3']
          $("#"+u+'_1').html(html1)
          $("#"+u+'_2').html(html2)
          $("#"+u+'_3').html(html3)
        }
      }
    )
  }
  $("[rel='tooltip']").tooltip();

  $(".edit-name").click(function() {
    <!--$(".hidden").toggle()-->
    $(".editing-name").toggleClass("hidden")
    $(".form-name").toggleClass("hidden")
    $(".btn").toggleClass("hidden")
  })
  $(".edit-description").click(function() {
    <!--$(".hidden").toggle()-->
    $(".editing-description").toggleClass("hidden")
    $(".form-description").toggleClass("hidden")
    $(".btn").toggleClass("hidden")
  })

  $(".confirm-del-geoms").click(function(){
    return confirm('DANGER! Deletes all place_geom records created so far in Review step');
  })
  $(".confirm-del-all").click(function(){
    id=$(this).data('id')
    return confirm('DANGER! Destroys task, its hits, and clears matches confirmed in Review step...'+id);
  })
</script>

<!--
js for Browse
-->
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script  type="text/javascript">
  $("[rel='tooltip']").tooltip();
  
  defaultStyle = {radius: 2, fillOpacity: 0.8, opacity: 1, stroke: false, fillColor:"#ff0000"}
  focusStyle = {radius:12,fillColor:"#ff0000",fillOpacity:0.5,stroke:true,weight:1,color:"#000000"}
  
  function focusFeature(feat){
    <!--console.log('feat',feat)-->
    feat.setStyle(focusStyle)
    <!--mappy.setView(feat._latlng, 3);-->
  }
  function setRowEvents(){
    $("#placetable tr").click(function() {
        t=$(this)
        pid=$(this)[0].cells[0].textContent
        var selected = $(this).hasClass("highlight-row");
        $("#placetable tr").removeClass("highlight-row");
        if(!selected)
          $(this).removeClass( "rowhover" );
          $(this).addClass("highlight-row");
        // highlight fillColor:bright red, opacity .7, color:red , zoomTo, level 3
        if(typeof(idToFeature) != 'undefined'){
          if(pid in idToFeature){
            features.setStyle(defaultStyle)
            feat = idToFeature[pid]
            focusFeature(feat)
          }
        }
        getPlace(pid)
      }
    ) 
        
    row = $("#drftable_list table tbody")[0].rows[0]
    pid = parseInt(row.cells[0].textContent)
    // display first row detail
    $("#placetable tbody").find('tr').eq(0).addClass('highlight-row')
    getPlace(pid)
  }
  
  $(function() {
    window.spinner = new Spin.Spinner().spin();
    $("#map").append(spinner.el);
    
    window.dslabel = "{{ object.label }}"
    window.table = $('#placetable').DataTable({
      "serverSide": true,
      "ajax": "/api/places/?format=datatables&ds={{ object.label }}&f={{ filter }}",
      "columns": [
          {"data": "id", "searchable": false},
          {"data": "src_id", "searchable": false},
          {"data": "title"},
          {"data": "ccodes"},
          <!--{"data": "geom_count","sortable": false},-->
      ],
    })
    table.on( 'draw', function () {
      setRowEvents();
    });
  })  

  // expose leaflet map for events, call it 'mappy'
  window.addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
    mappy.setMaxBounds(null)
    var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      attrib_awmc = 'Tiles and Data &copy; 2013 <a href="http://www.awmc.unc.edu" target="_blank">AWMC</a>',
      token_mb = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
      token_kg = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiUmVralBPcyJ9.mJegAI1R6KR21x_CVVTlqw',
      token_awmc = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiY2prcmgwc2cwMjRuZzNsdGhzZmVuMDRqbCJ9.MeLsyeOqwhTRdvt_Hgo7kg',
      token_whg = '',
      mbtiles_url = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}';
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var awmc = L.tileLayer(mbtiles_url, {id:'isawnyu.map-knmctlkh', token:token_awmc, attribution:attrib_awmc}),
      grayscale = L.tileLayer(mbstyle_url, {id:'kgeographer/cjstfpenh6o1e1fldz95w8m6p', token:token_kg, attribution:attrib_mb}),
      satellite  = L.tileLayer(mbtiles_url, {id:'mapbox.satellite', token:token_mb, attribution:attrib_mb}),
      osm  = L.tileLayer(mbtiles_url, {id:'mapbox.light', token:token_mb, attribution:attrib_mb});

    var baseLayers = {
      "AWMC Terrain": awmc,
      "OSM": osm,
      "Spine Data": grayscale,
      "Satellite": satellite
    };
    L.control.layers(baseLayers).addTo(mappy);
    baseLayers['OSM'].addTo(mappy)
    
    var printer = L.easyPrint({
      tileLayer: osm,
      sizeModes: ['Current'],
      filename: 'myMap',
      exportOnly: true,
      hideControlContainer: true
    }).addTo(mappy);

    function manualPrint () {
        printer.printMap('CurrentSize', 'MyManualPrint')
    }
    $.get("/api/geoms", {ds: "{{ object.label }}", f: "{{ filter }}" },
      function(data){
        console.log('data, label',data,dslabel)
        $("#feature_count").html(data.count+' geometries for {{ ds.numrows }} records')
        geom = {"type":"FeatureCollection","features":[]}
        <!--$.each(data.results, function( index, record ) {-->
          <!--console.log(index,record)-->
        <!--})-->
        geom['features'] = data.results
        if(geom.features.length < 15000) {
          renderMap(geom,dslabel)
        } else {
          spinner.stop()
          $(".toomany").html('too many features to map (> '+geom.features.length+'), sorry!')
        }
        
      })    
  }, false);
  
  function url_it(str) {
    // resolves source alias; returns url where appropriate
    <!--console.log('url_it() str',str)-->
    uri = ''
    if(str.startsWith('black') || str.startsWith('dplace')) {
      // TODO: applicable for links?
      link = str
    } else {
      if (str.startsWith('tgn')) {uri = str.replace('tgn:','http://vocab.getty.edu/page/tgn/')} 
      else if(str.startsWith('dbp')) {uri = str.replace('dbp:','http://dbpedia.org/resource/')}
      else if(str.startsWith('gn')) {uri = str.replace('gn:','http://www.geonames.org/')}
      else if(str.startsWith('wwf:')) {uri = str.replace('wwf:','https://www.worldwildlife.org/ecoregions/')}
      else if(str.startsWith('wd:')) {uri = str.replace('wd:','https://www.wikidata.org/wiki/')}
      link = '<span class="small mr-2"><a href="'+ uri +'" class="ext" target="_blank">['+
        str+']</a></span>'
    }
    <!--<a class="mr-2 ext" data-toggle="modal" data-target="#ext_site" href="'+sug['id']+-->
                <!--'">{ link }} {# fontawesome_icon 'external-link' color='#336699' #}</a>-->
    return link;
  }
  function url_modal(identifier) {
    <!-- e.g. 'wd:Q123456' -->
    link = ' <a href="" class="ext" data-toggle="modal" data-target="#ext_site">'+identifier+
      ' {% fontawesome_icon 'external-link' color='#336699' %}</a>'
    return link
  }
  function renderMap(geom,dslabel){
    console.log('geom',geom)
    if (geom.features.length==0) {spinner.stop()}
    
    geomtype = geom['features'][0]['type']
    <!--clear out the previous if any-->
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
    }
    // blue if rivers
    // TODO: style should depend on #features, zoom level
    function styler(type) {
      if (type == 'MultiLineString')
        return {opacity: 1, weight: 1, color: "#336699"}
      else if (type == 'Point')
        return {radius: 2, fillOpacity: 0.8, opacity: 1, stroke: false, fillColor:"#ff0000"}
      else
        return {fillOpacity: 0.4, opacity: 1, color: "#fff", weight: 1, fillColor:"#993333"}
    }
    idToFeature = {}  // for feature lookup
    features = L.geoJSON(geom, {
    // TODO: 
      style: styler(geomtype),
      pointToLayer: function (feature, latlng) {
        <!--console.log('feature in renderMap()',feature)-->
        matchid = feature.place_id_id
        <!--console.log('matchid',matchid)-->
        marker = L.circleMarker(latlng).bindPopup('pid: '+matchid);
     
        idToFeature[matchid] = marker
        return marker
      }
      ,onEachFeature: function(feature,layer) {
        f=feature; l=layer;
        <!--console.log('f,l',feature,layer)-->
        identifier = feature.place_id_id;
        if(feature.type != 'Point'){
          <!--layer.setStyle(styles.default)-->
          idToFeature[identifier] = layer
        }
      }
    <!--}).addTo(mappy).then(spinner.stop());-->
    }).addTo(mappy);
    <!--}).addTo(mappy)-->
    
    mappy.on('zoomend', function() {
        var currentZoom = mappy.getZoom();
        <!--var myRadius = currentZoom*(1/2); //or whatever ratio you prefer-->
        var myRadius = currentZoom*(1); //or whatever ratio you prefer
        var myWeight = currentZoom*(1/5); //or whatever ratio you prefer
        features.setStyle({radius: myRadius, weight: myWeight});
    });
    
    if (geom['features'].length > 1 && geom['features'][0].type == 'Point') {
      <!--mappy.fitBounds(features.getBounds().pad(1))-->
      mappy.fitBounds(features.getBounds())
    } else {
      feat0 = geom['features'][0]
      if (feat0.type == 'Point') {
        latlng = L.latLng(
          feat0.coordinates[1],
          feat0.coordinates[0])
        mappy.setView(latlng, 4)
      } else if (['MultiLineString','MultiPolygon'].includes(feat0.type)) {
        mappy.fitBounds(features.getBounds())
      }
    }
    spinner.stop()
  }
  // TODO: better parsing here
  function parsePlace(data,side) {
    window.featdata = data
    function minmax(timespans){
      starts=[]; ends=[]
      for (t in timespans){
        starts.push('in' in timespans[t]['start'] ?  timespans[t]['start']['in'] : timespans[t]['start']['earliest'])
        ends.push('in' in timespans[t]['end'] ?  timespans[t]['end']['in'] : timespans[t]['end']['earliest'])
      } 
      minmax=[Math.min((starts)),Math.max((ends))]
      return minmax
    }


    function onlyUnique(array) { 
      const map = new Map();
      const result = [];
      for (const item of array) {
        if(!map.has(item.identifier)){
            map.set(item.identifier, true);
            result.push({
                identifier: item.identifier,
                type: item.type
            });
        }
      }
      return(result)
    }
    
    //
    // TITLE 
    left='<p><b>Title</b>: <span id="row_title" class="larger text-danger">'+data.title+'</span>'
    //
    // NAME VARIANTS
    left+='<p class="scroll60"><b>Variants</b>: '
    for (n in data.names) {
      left+= '<p>'+data.names[n].toponym !=''?data.names[n].toponym+'; ': ''
    }
    //
    // TYPES
    left+='</p><p><b>Types</b>: '
    typeids = ''
    for (t in data.types) {
      <!--console.log('type:',t)-->
      typeids+=data.types[t].sourceLabel?data.types[t].sourceLabel +
        ' (<i>'+data.types[t].label+'/'+data.types[t].identifier +'</i>); ':
        '(<i>'+data.types[t].label+'/'+data.types[t].identifier +'</i>); '
    }
    left += typeids.replace(/(; $)/g, "") +'</p>'
    //
    //
    // LINKS
    // TODO: normalize on closeMatch, exactMatch
    left += '<p class="mb-0"><b>Linked records</b>: </p>'
    close_count = exact_count = related_count = 0
    html_exact = html_close = html_related = ''
    if (data.links.length > 0) {
      window.links=data.links
      links_arr = onlyUnique(data.links)
      <!--console.log('distinct data.links',links_arr)-->
      for (l in links_arr) {
        if (links_arr[l].type.substring(0,5) == 'exact') {
          exact_count += 1
          html_exact+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type.substring(0,5) == 'close') {
          close_count += 1
          html_close+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type == 'related') {
          related_count +=1
          html_related+=url_modal(links_arr[l].identifier)
        }
      }
      if (exact_count > 0) left += '<i>exactMatch</i>: ['+html_exact+' ]'
      if (close_count > 0) left += ' <i>closeMatch</i>: ['+html_close+' ]'
      if (related_count > 0) left += ' <i>related</i>: ['+html_related+' ]'
    } else { left += "<i class='small'>no links established yet</i>" }

    //
    // RELATED
    right=''
    if (data.related.length > 0) {
      right_parent='<p class="mb-0"><b>Parent(s)</b>: '; 
      right_related='<p class="mb-0"><b>Related</b>: ';
      for (r in data.related){
        rel = data.related[r]
        <!--console.log('rel',rel)-->
        if (rel.relation_type == 'gvp:broaderPartitive'){
          right_parent += '<span class="small h1em">'+rel.label
          right_parent += 'when' in rel && !('timespans' in rel.when) ? 
            ', '+rel.when.start.in+'-'+rel.when.end.in : 'when' in rel && ('timespans' in rel.when) ? ', '+
              minmax(rel.when.timespans) : ''
          <!--html_parent += 'when' in rel and !(timespans in rel.when) ? ', '+rel.when.start.in+'-'+rel.when.end.in : ''-->
          right_parent += '</span>; '
        } 
        else {
          right_related += '<p class="small h1em">'+rel.label+ ', '+rel.when.start.in+'-'+rel.when.end.in+'</p>'
        }
      }
      right+=right_parent.length > 39?right_parent:''
      right+=right_related.length > 37?right_related:''
    }
    //
    // DESCRIPTIONS
    // TODO: link description to identifier URI if present
    if (data.descriptions.length > 0) {
      val = data.descriptions[0]['value'].substring(0,300)
      right+='<p><b>Description</b>: '+(val.startsWith('http')?'<a href="'+val+'" target="_blank">Link</a>':val)
        +' ... </p>'
        <!--'<br/><span class="small red-bold">('+data.descriptions[0]['identifier']+')</span>-->
    }
    //
    // CCODES
    //
    <!--if (data.ccodes.length > 0) {-->
    if (!!data.countries) {
      <!--console.log('data.countries',data.countries)-->
      right+='<p><b>Modern country bounds</b>: '+ data.countries.join(', ')+'</p>'
    }
    
    left += '</div>'
    right += '</div>'
    return side=='left'?left:right
  }

  function getPlace(pid){
    $.ajax({
      url: "/api/places/"+pid,
      }).done(function( data ) {
        console.log('data',data)
        <!--$("#row_title").html('<b>'+data['title']+'</b>')-->
        <!--$("#drftable_fields").html(parsePlace(data))-->
        $("#detail_left").html(parsePlace(data,'left'))
        $("#detail_right").html(parsePlace(data,'right'))
        $('.ext').on('click', function(e) {
        e.preventDefault();
          str=$(this).text()
          var re = /(dbp|gn|tgn|wd):(.*?)$/;
          url=base_urls[str.match(re)[1]]+str.match(re)[2]
          console.log('url',url)
          $(".modal-body").html('<iframe width="100%" height="100%" frameborder="0" scrolling="yes" '+
            'allowtransparency="true" src="'+url+'"></iframe>');
        });
      });
  }
  // initialize, render map
  function map_init (map, options) {
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
      mappy.setView([35.0, 13.0], 1)
    }
    $('.edit-row').on('click', function(){
      alert('open a modal with full record')
    })
    // console.log('in map_init()')
    geom = {"type":"FeatureCollecton","features":[]}
    
  } // end map_init
  
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

</script>
{% endblock %}
