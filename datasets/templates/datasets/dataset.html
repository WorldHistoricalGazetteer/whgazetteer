{% extends "main/base.html" %}
{% load static %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load mathfilters %}
{% load dataset_extras %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <script src="{% static 'js/easyprint.js' %}"></script>
  <script src="{% static 'js/spin.umd.js' %}"></script>
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
{% endblock %}
{% block title %}<title>Dataset::{{ ds.label }}</title>{% endblock %}
{% block content %}
<div id="dataset_content" class="container mt-1 px-1">
  <!-- Title + nav tabs -->
  <ul class="nav nav-tabs" id="dataset_tabs" role="tablist">
    <span class="ds-title ml-1 mr-3">{{ ds.name }}</span>
    <li class="nav-item">
      <a class="nav-link active" id="summary-tab" data-toggle="tab" href="#summary" role="tab" aria-controls="summary" aria-selected="true">Metadata</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="browse-tab" data-toggle="tab" href="#browse" role="tab" aria-controls="browse" aria-selected="false">Browse</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="reconciliation-tab" data-toggle="tab" href="#reconciliation" role="tab" aria-controls="reconciliation" aria-selected="false">Reconciliation</a>
    </li>
    <li id="addtask_li" class="nav-item hidden">
      <a class="nav-link" id="addtask-tab" data-toggle="tab" href="#addtask" role="tab" aria-controls="addtask" aria-selected="false">Add reconciliation task</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="sharing-tab" data-toggle="tab" href="#sharing" role="tab" aria-controls="sharing" aria-selected="false">Sharing</a>
    </li>
  </ul>
  <!-- Tab panes -->
  <div class="tab-content">
    <div id="summary" class="tab-pane fade show active" role="tabpanel" aria-labelledby="summary-tab">
      <form id="ds_form" method="POST" action="#" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row">
      <div id="ds_details" class="col-sm-8 small">
        <table id="ds_metadata">
          <tr>
            <td><b>Title</b></td>
            <td><span class="form-name bigger strong text-danger">{{ ds.name }}</span>
              <span class="hidden editing-name">{{ form.name }}</span>&nbsp;
              <span class="edit-name small"><a href="#">{% fontawesome_icon 'edit' color='#336699' %}</a></span>
            </td>
          </tr>
          <tr>
            <td style="vertical-align:top;"><b>Description</b></td>
            <td><span class="form-description">{{ ds.description }}</span>
          <span class="hidden editing-description">{{ form.description }}</span>
          &nbsp;<span class="edit-description small"><a href="#">{% fontawesome_icon 'edit' color='#336699' %}</a></span>
            </td>
          </tr>
          <tr>
            <td><b>ID / label</b></td>
            <td>{{ ds.id }} / {{ ds.label }}
            </td>
          </tr>
          <tr>
            <td><b>File</b></td>
            <td>{{ ds.file }}</td>
          </tr>
          <tr>
            <td><b>Uploaded</b></td>
            <td>{{ ds.upload_date|date:"d-M-Y, H:i (e)" }}</td>
          </tr>
          <tr>
            <td><b>Data type</b></td>
            <td>{{ ds.datatype }}</td>
          </tr>
          <tr>
            <td><b>URI base</b></td>
            <td>{{ ds.uri_base }}</td>
          </tr>
          <tr>
            <td><b>Format</b></td>
            <td>{{ ds.format }} {% if ds.format == 'delimited' %}({{ ds.delimiter }}){%endif%}</td>
          </tr>
          <tr>
            <td><b>License</b></td>
            <td><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a></td>
          </tr>
          {% if ds.format == 'delimited' %}
          <tr>
            <td><b>Columns</b></td>
            <td>{{ ds.header }}</td>
          </tr>
          {% endif %}
          {% if ds.mapbox_id %}
          <tr>
            <td><b>MapBox ID</b></td>
            <td><p class="form-value"><b>MapBox ID</b>: {{ ds.mapbox_id }}</p>
                <p class="hidden editing"><b>MapBox ID</b>: {{ form.mapbox_id }}</p></td>
          </tr>
          {% endif %}
        </table>
        <input class="btn btn-primary hidden" type="submit" value="Save" />
      </div>
      <div class="col-sm-4 small">
        <!--<h6 class="text-secondary">Statistics <small>( initial, <span class="bg-danger text-white small">&nbsp;added </span>&nbsp;)</small></h6>-->
        <div id="ds_stats">
          <table style="width:100%">
            <tr><td class="pb-3"><b>Status</b></td><td class="pb-3">{{ ds.status }}</td><td class="pb-3"></td></tr>
            <tr><th></th><th class="pb-1 text-secondary">count</th><th class="pb-1 text-secondary">added</th></tr>
            <tr><td><b>Rows</b></td><td>{{ ds.numrows }}</td><td class="text-secondary">n/a</td></tr>
            <tr><td><b>Names</b></td><td>{{ num_names }}</td><td class="text-secondary">n/a</td></tr>
            <tr>
              <td><b>Links</b></td><td>{{ num_links }}</td>
              <td><span class="text-white bg-danger">&nbsp;{{ links_added }}&nbsp;</span></td></tr>
            <tr>
              <td><b>Geometries</b></td><td>{{ num_geoms }}</td>
              <td><span class="text-white bg-danger">&nbsp;{{ geoms_added }}&nbsp;</span></td></tr>
          </table>
        </div>
        <div id="ds_access" class="pt-0 px-0">
          <p style="display:block; background-color:#eee; margin:0; padding-left:10px; font-weight:700;">Access</p>
          <p style="display:block; margin:0; padding-left:10px;">Metadata edits, dataset updates, and initiation of reconciliation tasks may only be performed by the dataset contributor ("owner" in WHG). Collaborators added by the owner under the "Sharing" tab can view the dataset and perform review of reconciliation tasks.</p>
        </div>
        <div id="update_button"><a href="#">Update dataset</a> <span class="help-matches" data-id="updates">
            {% fontawesome_icon 'question-circle' color='#993333' %}</span></div>
      </div>
      </div> <!-- row -->
      </form>
    </div>
    <div id="browse" class="tab-pane fade" role="tabpanel" aria-labelledby="browse-tab">
        <div class="container mt-3">
          <div class="row">
            <div id="drftable_detail" class="col-sm-6 pl-0">
              <div id="mapdiv_browse">
                  {% leaflet_map "map" callback="map_init" %}
                  <div class="spinner-border text-danger"></div>
              </div>
              <!-- row detail in 2 columns, populated with getPlace() -->
              <div id="row_detail" class="row">
                <div id="detail_left" class="small col-sm-6">left side</div>
                <div id="detail_right" class="small col-sm-6">right side</div>
              </div>
            </div> <!-- drftable_detail -->
            <div id="drftable_list" class="col-sm-6">
              <table id="placetable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th>pid</th>
                    <th>src_id</th>
                    <th>title</th>
                    <th>ccodes</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      <div id="ext_site" class="modal fade" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span></button>
            </div>
            <div id="ext_content" class="modal-body">foo</div>
          </div>
        </div>
      </div> <!-- ext_site -->
    </div> <!-- browse -->
    <div id="reconciliation" class="tab-pane fade" role="tabpanel" aria-labelledby="reconciliation-tab">
      <div id="ds_tasks" class="small">
        <h6 class="">Reconciliation Tasks 
          <span class="small help-matches" data-id="reconciliation">
            {% fontawesome_icon 'question-circle' color='#993333' %}</span>
          {% if ds.owner.id == user.id or user.is_superuser %}
          <span class="float-right small">
            <a id="addtask_link" href="#" >Add new task {% fontawesome_icon 'plus-square' color='#336699' %}</a>
          </span>
          {% endif %}
        </h6>
        {% if ds.owner.id == user.id or user.is_superuser or user in users %}
        {% for t in tasks %}
        <div class="task-box mb-2">
          <!-- TODO: display bounds used if any -->
          <!--{ t.task_kwargs|parsejson:"bounds" }}-->
          <div class="row">
            <div class="col-sm-5">
              <p><b>Task</b>: {{ t.task_name }} <span class="small">
                ({{ t.date_done|date:"d-M-Y, H:i (e)" }}; elapsed: {{ t.result|get:"elapsed"|safe }})</span>
              </p>
              <p><b>ID</b>: {{ t.task_id }}</p>
              <p class="small">
                 <a class="confirm-del-all" data-id={{t.task_id}} href="{% url 'datasets:task-delete' tid=t.task_id scope='task' %}">
                   Delete task & hits, clear matches {% fontawesome_icon 'trash' color='#ff0000' %}</a><br/>
                   <a class="confirm-del-geoms" href="{% url 'datasets:task-delete' tid=t.task_id scope='geoms'%}">
                  Delete geometries added so far</a>
              </p>
            </div>
            <div class="col-sm-5">
              <p><b>Result</b>: {{ t.result|get:"got_hits"|safe }} records (of
                  {{ t.result|get:"count"|safe }}) got total of <b>{{ t.result|get:"total"|safe }}</b> hits</p>
              <p id="latest"></p>
              <ul>
                <li><i>Pass 1</i>
                  {% if t.result|get:"pass1" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_1'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass1' %}">
                   review</i></a>{% endif %}
                </li>
                <li><i>Pass 2</i>
                  {% if t.result|get:"pass2" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_2'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass2' %}">
                   review</i></a>{% endif %}
                </li>
                {% if t.task_name != 'align_wd' %}
                <li><i>Pass 3</i>
                  {% if t.result|get:"pass3" > 0 %}
                  <i>remaining</i>: <span class="strong" id='{{t.task_id}}_3'>nn</span> 
                  <a href="{% url 'datasets:review' pk=ds.id tid=t.task_id passnum='pass3' %}">
                   review</i></a>{% endif %}
                </li>
                {% endif %}
              </ul>            
            </div>
            <div class="col-sm-2">
              {% if t.task_name == 'align_wd' %}
                <img src="{% static 'images/Wikidata-logo-en.svg'%}" width="80"/>
              {% elif t.task_name == 'align_tgn' %}
                <img src="{% static 'images/getty80.png'%}" />
              {% elif t.task_name == 'align_whg' %}
                <img src="{% static 'images/whg_accessioning.svg'%}" width="80"/>
              {% endif %}
            </div>
          </div> <!-- row -->
        </div> <!-- task-box -->
        {% endfor %}
        {% endif %}
      </div>
    </div>
    <div id="sharing" class="tab-pane fade" role="tabpanel" aria-labelledby="sharing-tab">
      <form id="sharing_form" method="POST" action="{% url 'datasets:collab-add' dsid=ds.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div></div>
      <div class="sharing-box my-3 w-50">
        <div class="sharing-header">Collaborators
          {% if ds.owner.id == user.id or user.is_superuser %}
          <!--<span class="float-right small mr-2">-->
          <span class="sharing-input float-right input-group">
            <input type="text" class="form-control input-sm" name="username" placeholder="Enter username">
            <div class="input-group-append">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Add</button>
            </div>
          </span>
          {% endif %}
        </div>
        <p class="p-block px-2">Collaborators are assigned per dataset. They can view its contents and metadata, and  perform review of reconciliation task results.</p>
        <ul id="collabs_list">
          {% for c in collab %}<li>{{ c.user }} ({{ c.role }})
          {% if ds.owner.id == user.id or user.is_superuser %}
          <span class="float-right mr-2">
            <a href="{% url 'datasets:collab-delete' uid=c.id dsid=ds.id %}">
            {%fontawesome_icon 'times-circle' color='#336699'%}</a>
          </span>{% endif %}
          </li>{% endfor %}
        </ul>
        {% if messages %}{% for message in messages %}
          <i style="display:block;" class="text-danger ml-4 mb-2">{{ message }}</i>
        {%endfor%}{% endif %}            
      </div>
      </form>
    </div>
    <div id="addtask" class="tab-pane" role="tabpanel" aria-labelledby="addtask-tab">
      <form action="{% url 'datasets:ds_recon' ds.id %}" method="POST">
      {% csrf_token %}
      {% if ds.owner.id == user.id or user.is_superuser %}
      <!--from context: { area_list }}-->
      <div class="row"> <!-- page-wide -->
        <div id="recon_form" class="col-md-6">
          <input type="hidden" name="ds" value="{{ ds.id }}">
          {% if user.is_superuser %}
          <div class="form-check text-danger">
            <label class="form-check-label" for="auth1">
              <input type="radio" class="form-check-input" id="auth1"
                name="recon" value="whg">WHG Index (whg)
            </label>
          </div>
          <hr/>
          {% endif %}
          <p class="font-weight-bold">Authority name source</p>
          <div class="form-check">
            <label class="form-check-label" for="auth2">
              <input type="radio" class="form-check-input" id="auth2"
                name="recon" value="tgn" checked>Getty TGN (tgn)
            </label>
          </div>
          <div class="form-check">
            <label class="form-check-label" for="auth4">
              <input type="radio" class="form-check-input" id="auth4"
                name="recon" value="wd" >Wikidata (wd)<span class="ml-2 text-danger"><i>1+ seconds per record</i></span>
            </label>
          </div>
          <div class="form-check">
            <label class="form-check-label text-muted" for="auth3">
              <input type="radio" class="form-check-input" id="auth3"
                name="recon" value="dbp" disabled>DBpedia (dbp)
            </label>
          </div>
          <div class="form-check">
            <label class="form-check-label text-muted" for="auth5">
              <input type="radio" class="form-check-input" id="auth5"
                name="recon" value="gn" disabled>GeoNames (gn)
            </label>
          </div>
          {% if request.method == 'GET' %}
          <div id="geo-constraint" class="mt-2">
            <hr/>
            <div class="mb-2">
              <p class="font-weight-bold">Geographic constraint</p>
              <p>
                <select id="select_region" name="region" class="custom-select-sm" style="width:auto;">
                  <option value="0">Select pre-defined region</option>
                  <option disabled>___________</option>
                  {% for r in region_list %}
                    <option value="{{ r.id }}">{{ r.title }}</option>
                  {% endfor %}
                </select><span class="ml-2"><b>or...</b></span></p>
              <p>
                <select id="select_userarea" name="userarea" class="custom-select-sm" style="width:auto;">
                  <option value="0" selected="selected">Select user-defined study area</option>
                  <option disabled>___________</option>
                  {% for a in area_list %}
                      <option value="{{ a.id }}">{{ a.title }}</option>
                  {% endfor %}
                  <option value="create">{ new }</option>
                </select>
              <span class="ml-2 small">
                <a href="{% url 'areas:area-create' %}?next={% url 'datasets:ds_recon' ds.id %}">create user area</a>
              </span></p>
              <!--<p><input type="text" disabled id="search_region" name="search_region" value="" placeholder="Search region data (future)"/></p>-->
            </div>
          </div>
          <div class="bottom">
            <hr/>
            <button type="submit" class="btn btn-primary">Start</button>
            <span title="back"><a id="cancel_taskadd" href="#">Cancel</a></span>
            <span id="q_accept" class="ml-3 small">
              <input id="accept_geom" name="geom" type="checkbox" checked="checked"/> accept geometries in matches
          <span class="help-matches" data-id="accept-geometry">{% fontawesome_icon 'question-circle' color='#993333' %}</span>
            </span>
          </div>
          {% endif %}
        </div> <!-- recon_form -->
        <div id="recon_result" class="col-md-6 p-tight py-2 dashedbox">
          {% if context.response and context.response != 'snap!' %}
            <div>
            <p class="text-warning">{ TODO: progress bar }</p>
            <p><b>Authority</b>: {{ context.authority }}</p>
            <p><b>Task ID</b>: {{ context.task_id }}</p>
            <p class="mb-3"><b>Result summary</b>:
              {{ context.result }}    </p>
            <a href="{% url 'datasets:dataset-detail' id=ds.pk %}">
              <input class="btn btn-sm btn-outline-primary" type="text" value="Return to Dataset"/></a>
            <!-- TODO: refactor this; direct to first non-zero pass -->
            {% if context.result.pass1 > 0 %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass1' %}">
            {% elif context.result.pass2 > 0 %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass2' %}">
            {% else %}
              <a href="{% url 'datasets:review' pk=ds.pk tid=context.task_id passnum='pass3' %}">
            {% endif %}
            <input class="btn btn-sm btn-outline-primary" type="text" value="Review Hits"/>
            </a></div>
          {% elif context.response == 'snap!' %}
            <div><p>{{ context.result }}</p>
            <p><a href="javascript:history.back()">Return to dataset portal</a></p></div>
          {% endif %}
          {% if request.method == 'GET' %}
          <div id="mapdiv_recon" class="mt-2">
            {% leaflet_map "map_recon" callback="map_init2" %}
          </div>
          {% endif %}
        </div> <!-- recon_result -->
      </div> <!-- row -->
      {% else %}
      <div><p class="pl-3 text-danger"><b>Sorry, as you are not the dataset owner, initiating reconciliation tasks for it is not possible.</b></p></div>
      {% endif %}
      </form>
        <div class="selector py-3"><div id="helpme"></div></div>
      </div> <!-- .row -->
    </div> <!-- #addtask -->
  </div> <!-- .tab-content -->
</div>

<!--
js for Summary, Reconciliation
-->
<script type="text/javascript">
  $(function(){
    // manage url
    var url = document.location.toString();
    console.log('url, context on load',url,"{{context}}".length)
    if (url.match('#')) {
      tab = url.split('#')[1]
      $('.nav-tabs a[href="#' + tab+ '"]').tab('show');
    } else if ("{{context}}".length > 0){
      taburl = location.protocol+'//'+location.host+'/datasets/'+'{{ds.id}}'+'/detail#reconciliation'
      $('.nav-tabs a[href="#reconciliation"]').tab('show');
      location.href=taburl
    }
    
    // start Browse onload js
    window.spinner = new Spin.Spinner().spin();
    $("#map").append(spinner.el);
    
    window.dslabel = "{{ ds.label }}"
    window.table = $('#placetable').DataTable({
      "serverSide": true,
      "ajax": "/api/places/?format=datatables&ds={{ ds.label }}&f={{ filter }}",
      "ajax": "/api/places/?format=datatables&ds={{ ds.label }}&f={{ filter }}",
      "columns": [
          {"data": "id", "searchable": false},
          {"data": "src_id", "searchable": false},
          {"data": "title"},
          {"data": "ccodes"},
          <!--{"data": "geom_count","sortable": false},-->
      ],
    })
    table.on( 'draw', function () {
      setRowEvents();
    });
    // end Browse onload js
    
    $("#update_button a").click(function(e){
      e.preventDefault();
      alert('Dataset updates are not yet available; coming soon.')
    })
    $("#cancel_taskadd").click(function(e){
      e.preventDefault();
      $('#addtask_li').addClass('hidden')
      $('.nav-tabs a[href="#reconciliation"]').tab('show');
    })
    $("#addtask_link").click(function(e){
      e.preventDefault()
      window.location.hash = "#addtask"
      $("#addtask_li").removeClass('hidden')
      $('.nav-tabs a[href="#addtask"]').tab('show');
      mappyr.invalidateSize()
    })
    <!--$("html,body").scrollTop(0);-->
    // Change hash for page-reload
    $('.nav-tabs a').on('shown.bs.tab', function (e) {
      <!--console.log('e.target.hash',e.target.hash)-->
      window.location.hash = e.target.hash;
      if(e.target.hash=="#reconciliation"){
        updateTotals('{{ ds.id }}')
      }
      if(e.target.hash=="#browse"){
        mappy.invalidateSize();
        $("html,body").scrollTop(0)
      }
      if(e.target.hash=="#addtask"){
        mappyr.invalidateSize();
        $("html,body").scrollTop(0)
      }
    })
    
    // TODO: reload should NOT be necessary
    <!--console.log('dataset id: {{ object.id }}')-->
    updateTotals('{{ ds.id }}')
    steps={"uploaded":1,"reconciling":2,"review_hits":3,"reviewed":4,"review_whg":5,"indexed":6}
    $("[ref="+steps['{{ ds.status }}']+"]").addClass('prog-active')

    $("#collabs_list a").click(function(){
      <!--console.log($(this).data('uid'))-->
    })   
    $(".help-matches").click(function(){
      page=$(this).data('id')
      $('.selector').dialog('open');
    })
    $(".selector").dialog({
      resizable: false,
      autoOpen: false,
      height: 600,
      width: 700,
      title: "WHG Help",
      modal: true,
      buttons: { 'Close': function() {$(this).dialog('close');} },
      open: function(event, ui) {
        $('#helpme').load('/media/help/'+page+'.html');
      },
      show: {effect: "fade",duration: 400 },
      hide: {effect: "fade",duration: 400 }
    });
  })
  function updateTotals(dsid){
    $.get("/search/updatecounts",{ds_id: dsid},
      function(data){
        updates=data
        <!--console.log('fired updateTotals()',updates, dsid)-->
        for(u in updates){
          html1='';html2='';html3='';
          <!--console.log(updates[u])-->
          html1+=updates[u]['pass1']
          html2+=updates[u]['pass2']
          html3+=updates[u]['pass3']
          $("#"+u+'_1').html(html1)
          $("#"+u+'_2').html(html2)
          $("#"+u+'_3').html(html3)
        }
      }
    )
  }
  $("[rel='tooltip']").tooltip();

  $(".edit-name").click(function() {
    <!--$(".hidden").toggle()-->
    $(".editing-name").toggleClass("hidden")
    $(".form-name").toggleClass("hidden")
    $(".btn").toggleClass("hidden")
  })
  $(".edit-description").click(function() {
    <!--$(".hidden").toggle()-->
    $(".editing-description").toggleClass("hidden")
    $(".form-description").toggleClass("hidden")
    $(".btn").toggleClass("hidden")
  })

  $(".confirm-del-geoms").click(function(){
    return confirm('DANGER! Deletes all place_geom records created so far in Review step');
  })
  $(".confirm-del-all").click(function(){
    id=$(this).data('id')
    return confirm('DANGER! Destroys task, its hits, and clears matches confirmed in Review step...'+id);
  })
</script>
<!--
js for Add Task
-->
<script type="text/javascript">
  function render_area(aid) {
    $.ajax({
        url: '/api/areas/'+aid
      }).done(function(data){
        <!--console.log('render_area()',data)-->
        geom = {"type":"FeatureCollecton","features":[]}
        geom['features'].push(data.geojson)
        // geom,dslabel,screen
        renderMap(geom,'area')
    })
  }
  // clear dropdown choice if other is used & render geometry
  $( "#select_region" ).change(function() {
    $( "#select_userarea option[value=0]" ).prop('selected',true)
    if ($(this).val() == 0) { features.clearLayers() } else{ render_area( $(this).val(), 'region') }
  });
  
  $( "#select_userarea" ).change(function() {
    $( "#select_region option[value=0]" ).prop('selected',true)
    if ($(this).val() == 0) { features.clearLayers() } else{ render_area( $(this).val(), 'area') }
    if ($( "#select_userarea option[value='create']" ).prop('selected') == true) {
      location.href="{% url 'areas:area-create' %}?next={% url 'datasets:ds_recon' ds.id %}"
    }
  });
</script>
<!--
js for Browse
-->
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script  type="text/javascript">
  $("[rel='tooltip']").tooltip();
  
  defaultStyle = {radius: 2, fillOpacity: 0.8, opacity: 1, stroke: false, fillColor:"#ff0000"}
  focusStyle = {radius:12,fillColor:"#ff0000",fillOpacity:0.5,stroke:true,weight:1,color:"#000000"}
  
  function focusFeature(feat){
    <!--console.log('feat',feat)-->
    feat.setStyle(focusStyle)
    <!--mappy.setView(feat._latlng, 3);-->
  }
  function setRowEvents(){
    $("#placetable tr").click(function() {
        t=$(this)
        pid=$(this)[0].cells[0].textContent
        var selected = $(this).hasClass("highlight-row");
        $("#placetable tr").removeClass("highlight-row");
        if(!selected)
          $(this).removeClass( "rowhover" );
          $(this).addClass("highlight-row");
        // highlight fillColor:bright red, opacity .7, color:red , zoomTo, level 3
        if(typeof(idToFeature) != 'undefined'){
          if(pid in idToFeature){
            features.setStyle(defaultStyle)
            feat = idToFeature[pid]
            focusFeature(feat)
          }
        }
        getPlace(pid)
      }
    ) 
        
    row = $("#drftable_list table tbody")[0].rows[0]
    pid = parseInt(row.cells[0].textContent)
    // display first row detail
    $("#placetable tbody").find('tr').eq(0).addClass('highlight-row')
    getPlace(pid)
  }

  // expose leaflet map for events, call it 'mappy'
  addEventListener('map:init', function (e) {
    <!--console.log('e.detail',e.detail.id)-->
    
    var attrib_mb = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      attrib_awmc = 'Tiles and Data &copy; 2013 <a href="http://www.awmc.unc.edu" target="_blank">AWMC</a>',
      token_mb = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
      token_kg = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiUmVralBPcyJ9.mJegAI1R6KR21x_CVVTlqw',
      token_awmc = 'pk.eyJ1Ijoia2dlb2dyYXBoZXIiLCJhIjoiY2prcmgwc2cwMjRuZzNsdGhzZmVuMDRqbCJ9.MeLsyeOqwhTRdvt_Hgo7kg',
      token_whg = '',
      mbtiles_url = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={token}';
      mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}';
      
    var awmc = L.tileLayer(mbtiles_url, {id:'isawnyu.map-knmctlkh', token:token_awmc, attribution:attrib_awmc}),
      grayscale = L.tileLayer(mbstyle_url, {id:'kgeographer/cjstfpenh6o1e1fldz95w8m6p', token:token_kg, attribution:attrib_mb}),
      satellite  = L.tileLayer(mbtiles_url, {id:'mapbox.satellite', token:token_mb, attribution:attrib_mb}),
      osm  = L.tileLayer(mbtiles_url, {id:'mapbox.light', token:token_mb, attribution:attrib_mb});

    var baseLayers = {
      "AWMC Terrain": awmc,
      "OSM": osm,
      <!--"Spine Data": grayscale,-->
      "Satellite": satellite
    };

    if (e.detail.id == 'map'){
      // it's the Browse map
      window.mappy = e.detail.map
      mappy.setMaxBounds(null)
      L.control.layers(baseLayers).addTo(mappy);
      baseLayers['OSM'].addTo(mappy)
      
      var printer = L.easyPrint({
        tileLayer: osm,
        sizeModes: ['Current'],
        filename: 'myMap',
        exportOnly: true,
        hideControlContainer: true
      }).addTo(mappy)
      
      $.get("/api/geoms", {ds: "{{ ds.label }}", f: "{{ filter }}" },
        function(data){
          <!--console.log('data, label',data,dslabel)-->
          $("#feature_count").html(data.count+' geometries for {{ ds.numrows }} records')
          geom = {"type":"FeatureCollection","features":[]}
          geom['features'] = data.results
          if(geom.features.length < 15000) {
            renderMap(geom,'browse')
          } else {
            spinner.stop()
            $(".toomany").html('too many features to map (> '+geom.features.length+'), sorry!')
          }
      })  
    } else {
      // it's the reconciliation study areas map
      window.mappyr = e.detail.map
      mappyr.setMaxBounds(null)
      L.control.layers(baseLayers).addTo(mappyr);
      baseLayers['OSM'].addTo(mappyr)
      mappyr.invalidateSize()
    }

    function manualPrint () {
        printer.printMap('CurrentSize', 'MyManualPrint')
    }
  }, false);
  
  function url_it(str) {
    // resolves source alias; returns url where appropriate
    <!--console.log('url_it() str',str)-->
    uri = ''
    if(str.startsWith('black') || str.startsWith('dplace')) {
      // TODO: applicable for links?
      link = str
    } else {
      if (str.startsWith('tgn')) {uri = str.replace('tgn:','http://vocab.getty.edu/page/tgn/')} 
      else if(str.startsWith('dbp')) {uri = str.replace('dbp:','http://dbpedia.org/resource/')}
      else if(str.startsWith('gn')) {uri = str.replace('gn:','http://www.geonames.org/')}
      else if(str.startsWith('wwf:')) {uri = str.replace('wwf:','https://www.worldwildlife.org/ecoregions/')}
      else if(str.startsWith('wd:')) {uri = str.replace('wd:','https://www.wikidata.org/wiki/')}
      link = '<span class="small mr-2"><a href="'+ uri +'" class="ext" target="_blank">['+
        str+']</a></span>'
    }
    <!--<a class="mr-2 ext" data-toggle="modal" data-target="#ext_site" href="'+sug['id']+-->
                <!--'">{ link }} {# fontawesome_icon 'external-link' color='#336699' #}</a>-->
    return link;
  }
  function url_modal(identifier) {
    <!-- e.g. 'wd:Q123456' -->
    link = ' <a href="" class="ext" data-toggle="modal" data-target="#ext_site">'+identifier+
      ' {% fontawesome_icon 'external-link' color='#336699' %}</a>'
    return link
  }
  <!--function renderMap(geom,dslabel,screen){-->
  function renderMap(geom,screen){
    <!--console.log('dslabel, geom in renderMap()',screen,geom)-->
    mappo = screen == 'browse' ? mappy : mappyr
    if (geom.features.length==0) {
      <!--console.log(geom.features)-->
      spinner.stop()
    } else {
      geomtype = geom.features[0]['type']
      <!--clear out the previous if any-->
      if(typeof(features)!=='undefined'){
        mappo.removeLayer(features)
      }
      // blue if rivers
      // TODO: style should depend on #features, zoom level
      function styler(type) {
        if (type == 'MultiLineString')
          return {opacity: 1, weight: 1, color: "#336699"}
        else if (type == 'Point')
          return {radius: 2, fillOpacity: 0.8, opacity: 1, stroke: false, fillColor:"#ff0000"}
        else
          return {fillOpacity: 0.4, opacity: 1, color: "#fff", weight: 1, fillColor:"#993333"}
      }
      idToFeature = {}  // for feature lookup
      features = L.geoJSON(geom, {
      // TODO: 
        style: styler(geomtype),
        pointToLayer: function (feature, latlng) {
          <!--console.log('feature in renderMap()',feature)-->
          matchid = feature.place_id_id
          <!--console.log('matchid',matchid)-->
          marker = L.circleMarker(latlng).bindPopup('pid: '+matchid);
       
          idToFeature[matchid] = marker
          return marker
        }
        ,onEachFeature: function(feature,layer) {
          f=feature; l=layer;
          <!--console.log('f,l',feature,layer)-->
          identifier = feature.place_id_id;
          if(feature.type != 'Point'){
            <!--layer.setStyle(styles.default)-->
            idToFeature[identifier] = layer
          }
        }
      }).addTo(mappo);
    }
    
    mappy.on('zoomend', function() {
        var currentZoom = mappy.getZoom();
        <!--var myRadius = currentZoom*(1/2); //or whatever ratio you prefer-->
        var myRadius = currentZoom*(1); //or whatever ratio you prefer
        var myWeight = currentZoom*(1/5); //or whatever ratio you prefer
        features.setStyle({radius: myRadius, weight: myWeight});
    });
    
    if (geom['features'].length > 1 && geom['features'][0].type == 'Point') {
      <!--mappy.fitBounds(features.getBounds().pad(1))-->
      mappy.fitBounds(features.getBounds())
    } else if (geom['features'].length > 0){
      feat0 = geom['features'][0]
      if (feat0.type == 'Point') {
        latlng = L.latLng(
          feat0.coordinates[1],
          feat0.coordinates[0])
        mappy.setView(latlng, 4)
      } else if (['MultiLineString','MultiPolygon'].includes(feat0.type)) {
        mappy.fitBounds(features.getBounds())
      }
    }
    spinner.stop()
  }
  // TODO: better parsing here
  function parsePlace(data,side) {
    window.featdata = data
    function minmax(timespans){
      starts=[]; ends=[]
      for (t in timespans){
        starts.push('in' in timespans[t]['start'] ?  timespans[t]['start']['in'] : timespans[t]['start']['earliest'])
        ends.push('in' in timespans[t]['end'] ?  timespans[t]['end']['in'] : timespans[t]['end']['earliest'])
      } 
      minmax=[Math.min((starts)),Math.max((ends))]
      return minmax
    }


    function onlyUnique(array) { 
      const map = new Map();
      const result = [];
      for (const item of array) {
        if(!map.has(item.identifier)){
            map.set(item.identifier, true);
            result.push({
                identifier: item.identifier,
                type: item.type
            });
        }
      }
      return(result)
    }
    
    //
    // TITLE 
    left='<p><b>Title</b>: <span id="row_title" class="larger text-danger">'+data.title+'</span>'
    //
    // NAME VARIANTS
    left+='<p class="scroll60"><b>Variants</b>: '
    for (n in data.names) {
      left+= '<p>'+data.names[n].toponym !=''?data.names[n].toponym+'; ': ''
    }
    //
    // TYPES
    left+='</p><p><b>Types</b>: '
    typeids = ''
    for (t in data.types) {
      <!--console.log('type:',t)-->
      typeids+=data.types[t].sourceLabel?data.types[t].sourceLabel +
        ' (<i>'+data.types[t].label+'/'+data.types[t].identifier +'</i>); ':
        '(<i>'+data.types[t].label+'/'+data.types[t].identifier +'</i>); '
    }
    left += typeids.replace(/(; $)/g, "") +'</p>'
    //
    //
    // LINKS
    // TODO: normalize on closeMatch, exactMatch
    left += '<p class="mb-0"><b>Linked records</b>: </p>'
    close_count = exact_count = related_count = 0
    html_exact = html_close = html_related = ''
    if (data.links.length > 0) {
      window.links=data.links
      links_arr = onlyUnique(data.links)
      <!--console.log('distinct data.links',links_arr)-->
      for (l in links_arr) {
        if (links_arr[l].type.substring(0,5) == 'exact') {
          exact_count += 1
          html_exact+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type.substring(0,5) == 'close') {
          close_count += 1
          html_close+=url_modal(links_arr[l].identifier)
        }
        else if (links_arr[l].type == 'related') {
          related_count +=1
          html_related+=url_modal(links_arr[l].identifier)
        }
      }
      if (exact_count > 0) left += '<i>exactMatch</i>: ['+html_exact+' ]'
      if (close_count > 0) left += ' <i>closeMatch</i>: ['+html_close+' ]'
      if (related_count > 0) left += ' <i>related</i>: ['+html_related+' ]'
    } else { left += "<i class='small'>no links established yet</i>" }

    //
    // RELATED
    right=''
    if (data.related.length > 0) {
      right_parent='<p class="mb-0"><b>Parent(s)</b>: '; 
      right_related='<p class="mb-0"><b>Related</b>: ';
      for (r in data.related){
        rel = data.related[r]
        <!--console.log('rel',rel)-->
        if (rel.relation_type == 'gvp:broaderPartitive'){
          right_parent += '<span class="small h1em">'+rel.label
          right_parent += 'when' in rel && !('timespans' in rel.when) ? 
            ', '+rel.when.start.in+'-'+rel.when.end.in : 'when' in rel && ('timespans' in rel.when) ? ', '+
              minmax(rel.when.timespans) : ''
          <!--html_parent += 'when' in rel and !(timespans in rel.when) ? ', '+rel.when.start.in+'-'+rel.when.end.in : ''-->
          right_parent += '</span>; '
        } 
        else {
          right_related += '<p class="small h1em">'+rel.label+ ', '+rel.when.start.in+'-'+rel.when.end.in+'</p>'
        }
      }
      right+=right_parent.length > 39?right_parent:''
      right+=right_related.length > 37?right_related:''
    }
    //
    // DESCRIPTIONS
    // TODO: link description to identifier URI if present
    if (data.descriptions.length > 0) {
      val = data.descriptions[0]['value'].substring(0,300)
      right+='<p><b>Description</b>: '+(val.startsWith('http')?'<a href="'+val+'" target="_blank">Link</a>':val)
        +' ... </p>'
        <!--'<br/><span class="small red-bold">('+data.descriptions[0]['identifier']+')</span>-->
    }
    //
    // CCODES
    //
    <!--if (data.ccodes.length > 0) {-->
    if (!!data.countries) {
      <!--console.log('data.countries',data.countries)-->
      right+='<p><b>Modern country bounds</b>: '+ data.countries.join(', ')+'</p>'
    }
    
    left += '</div>'
    right += '</div>'
    return side=='left'?left:right
  }

  function getPlace(pid){
    $.ajax({
      url: "/api/places/"+pid,
      }).done(function( data ) {
        <!--console.log('data',data)-->
        <!--$("#row_title").html('<b>'+data['title']+'</b>')-->
        <!--$("#drftable_fields").html(parsePlace(data))-->
        $("#detail_left").html(parsePlace(data,'left'))
        $("#detail_right").html(parsePlace(data,'right'))
        $('.ext').on('click', function(e) {
        e.preventDefault();
          str=$(this).text()
          var re = /(dbp|gn|tgn|wd):(.*?)$/;
          url=base_urls[str.match(re)[1]]+str.match(re)[2]
          console.log('url',url)
          $(".modal-body").html('<iframe width="100%" height="100%" frameborder="0" scrolling="yes" '+
            'allowtransparency="true" src="'+url+'"></iframe>');
        });
      });
  }
  // initialize, render map
  function map_init (map, options) {
    if(typeof(features)!=='undefined'){
      mappy.removeLayer(features)
      mappy.setView([35.0, 13.0], 1)
    }
    $('.edit-row').on('click', function(){
      alert('open a modal with full record')
    })
    // console.log('in map_init()')
    geom = {"type":"FeatureCollecton","features":[]}
    
  } // end map_init
  function map_init2 (map, options) {
    <!--console.log('in map_init_recon()')-->
    <!--geom_recon = {"type":"FeatureCollecton","features":[]}-->
    
  } // end
  
  function zoomTo(id) {
    mappy.setView(idToFeature[id]._latlng, mappy.getZoom() +2 )
  }

</script>
{% endblock %}
