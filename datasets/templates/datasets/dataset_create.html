<!-- datasets/dataset_create.html -->
{% extends "main/base.html" %}
{% block title %}<title>WHG::Create/Update</title>{% endblock %}

{% block content %}
{% load static %}
{% load fontawesome %}
{% load dataset_extras %}

  <div class="container">
    <h4 class="mt-3">
      {% if context.action == 'update' %}Update
      {% elif context.action == 'review'%}Review
      {% else %}Create
      {% endif %} dataset</h4>
      <form id="ds_form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {% if form.errors %}
          {% for field in form %}
              {% for error in field.errors %}
                  <div class="alert alert-danger">
                      <strong>{{ error|escape }}</strong>
                  </div>
              {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
              <div class="alert alert-danger">
                  <strong>{{ error|escape }}</strong>
              </div>
          {% endfor %}
        {% endif %}
      <div class="row mx-1" id="content_create">
        <div class="form-box mt-2 col-sm-5" id="create_form">
          <!-- status, format, delimiter, numrows, header  -->
          <input type="hidden" name="owner" value='{{ user.id }}'></input>
          {% if action == 'update' %}
            <input type="hidden" name="status" value='{{ form.status.value }}'></input>
            <input type="hidden" name="header" value='{{ form.header.value }}'></input>
          {% elif action == 'create' %}
            <input type="hidden" name="status" value=''></input>
            <input type="hidden" name="delimiter" value=''></input>
            <input type="hidden" name="numrows" value=-1></input>
            <input type="hidden" name="header" value=[]></input>
          {% endif %}
          <p>Name {{ form.name }}</p>
          <p>Unique label {{ form.label }}
            <span class="text-danger small"><i>20 char max, no spaces</i></span>
          </p>
          {% if errors %}<p>{{ errors }}</p>{% endif %}
          <p><span class="top">Description</span> {{ form.description }}</p>
          <p>Data type {{ form.datatype }}</p>
          <p>Format {{ form.format }}
<!--<a href="" title="{help:formats}" rel="tooltip">{ fontawesome_icon 'question-circle' color='#336699' %}</a>-->
          </p>
          <p>URI base {{ form.uri_base }}</p>
          {% if user.id == 1 %}<p>Spine? {{ form.spine }}</p>{% endif %}
          {% if form.mapbox_id != null %}
            <p>MapBox ID {{ form.mapbox_id }}</p>
          {% endif %}
          {% if action == 'update' %}
            <p>Current file <span class="text-danger" >{{ form.file.value }}</span></p>
            <p>Status <span class="text-danger" >{{ form.status.value }}</span></p>
          {% else %}
            <p>
              <input class="text-danger" type="file" name="file"
                value='{{ form.file }}'></input>
            </p>
          {% endif %}
          <br/>
          <!-- upload button only if it's not yet ok -->
          {% if status != 'format_ok' %}
          <input class="btn btn-primary" type="submit" value="Upload" />
          <span title="back"><a href="{% url 'dashboard' %}">Cancel</a></span>
          {% endif %}
        </div>
        <div class="mt-2 col-sm-7" id="create_review">
          {% if context.action == 'review' %}
              <h5>{% fontawesome_icon 'exclamation-circle' color="#993333" %} This file has one or more problems:</h5>
              <ul>
              {% for e in context.errors %}
                <li>{% if e.format == 'delimited' %}
                      {{ e.message }}
                    {% else %}
                      <b>row #{{ e.feat }}</b>: {{ e.error }}
                    {% endif %}</li>
              {% endfor %}
              </ul>
              <!--{ if context.errors.errors == 'delimiter' %}-->
                <!--<p class="my-0 strong">Couldn't determine delimiter. Columns in header and all rows must be delimited with either a tab or a pipe character (|). Please correct and upload again.</p>           -->
              <!--{ else %}-->
                <!--<ul>-->
                <!--{ for e in context.errors.errors %}-->
                  <!--{ if 'latlon' in e %}-->
                    <!--<li class="">{ e.latlon }}</li>-->
                  <!--{ endif %}              -->
                  <!--{ if 'delim' in e %}-->
                    <!--<li class="">{ e.delim }}</li>-->
                  <!--{ endif %}              -->
                  <!--{ if 'req' in e %}-->
                    <!--<li class="">{ e.req }}</li>-->
                  <!--{ endif %}-->
                <!--{ endfor %}-->
                </ul>
                <p>After making corrections, try reloading the file</p><hr/>
              <!--{ endif %}-->
              {% if context.errors|haskey:'req' %}
                <div class="ml-4">
                  <i class="my-0">Your columns</i>
                  <p>{{ context.errors.columns }}</p>
                  <i class="my-0">Allowed column names</i>
                  <p>['id', 'title', 'title_source', 'title_uri', 'ccodes', 'matches', 'variants', 'types', 'aat_types', 
                      'parent_name', 'parent_id', 'lon', 'lat', 'geowkt', 'geo_source', 'geo_id', 'start', 'end']</p>
                  <!--<p>After making corrections, try reloading the file</p><hr/>-->
                </div>
              {% endif %}
          {% else %}
            <div><p class="mb-0"><b>Sample data</b></p><p>During this beta phase, some sample datasets are available from our GitHub repository. Download <a href="https://github.com/kgeographer/whgazetteer/raw/master/example_data/beta_data.zip" download>this zip file</a>, check its README.txt file, and you can experiment with loading them from your local computer and reconciling them against TGN and/or Wikidata
            <p class="mb-0"><b>Data formats</b></p>
            <p>For place data there are two accepted formats, Linked Places (expressive, JSON-LD and GeoJSON compatible), and the simpler LP-TSV, a tab-delimited format for relatively simpler records. <a href="/tutorials/choosing">More information on making the choice</a>. <br/><span class="text-danger"><b>NOTE</b>: Encoding for all uploaded files must be unicode</span></p>
            <p><i>Trace data uploads are a work-in-progress at this time.</i></p>
            <p class="mb-0"><b>URI base</b></p>
            <p>If you have a permanent landing page for each of your records, supply the base URI in this field. Otherwise, leave as is, and a permanent URI within the whgazetteer domain will be generated based on your unique IDs.</p>
            </div>
          {% endif %}
        </div>
      </div> <!-- row#content_create -->
      {% if action == 'update' %}
      <!-- there are validation results-->
      <input type="hidden" name="file" value='{{ form.file }}'></input>
      <div class="form-box mt-3 ml-3" id="ds_errors">
        <h5>Validation Results</h5>
        {% if form.status.value != '' %}
          <p><b>numrows</b>: {{ form.numrows.value }}</p>
          <p><b>format</b>: {{ form.format.value }}</p>
          <p><b>delimiter</b>: {{ form.delimiter.value }}</p>
          <p><b>columns</b>: {{ form.header.value }}</p>
          <!-- <p>columns: {{ form.columns.value|make_list }}</p> -->
          {% if form.status.value == 'format_ok' %}
          <p>Not yet inserted, so button back to dashboard</p>
              <a href="{% url 'dashboard' %}">
                <input class="btn btn-primary" type="text" value="Dashboard"/></a>
          {% endif %}
        {% endif %}
      </div>
      {% endif %}
      </form>
    <!--</div> -->
  </div>
  <script type="text/javascript">
    $(function(){
      $('#id_format option[value="delimited"]').prop('selected',true)
      $('#id_datatype option[value="anno"]').prop('disabled',true)
      $('#id_datatype option[value="source"]').prop('disabled',true)
    })
    $("[rel='tooltip']").tooltip();
  </script>
{% endblock %}
