<!-- search/search.html -->
{% extends "main/base.html" %}
{% load leaflet_tags %}
{% load fontawesome %}
{% load static %}

{% block title %}<title>WHG Search</title>{% endblock %}
{% block extra_head %}
  {% leaflet_js %}
  {% leaflet_css %}
  <script src="{% static 'js/aliases.js' %}"></script>
  <script src="{% static 'js/parents.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/dataTables.bootstrap4.min.css">
  <script src="{% static 'js/leaflet.ajax.min.js' %}"></script>

  <script src="{% static 'leaf_bb/leaflet-control-boxzoom.js' %}"></script>
  <link rel="stylesheet" href="{% static 'leaf_bb/leaflet-control-boxzoom.css' %}">

  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
  <script src="{% static 'js/leaflet-mapbox-gl.js' %}"></script>

  <link rel="stylesheet" href="{% static 'css/spin.css' %}"/>
{% endblock %}

{% block content %}
{% load static %}

<div class="container">
  <div class="justify-content-center mt-2">
    <div id="search_top" class="row">
      <div id="search_left" class="col-sm-6">
        <div id="search_panel">

      <div id="search_input" class="d-input input-group input-group-sm pb-2 justify-content-center" >
        <input id="input_box" class="" type="text" placeholder="Enter place name" autocomplete="false">
        <button class="b-input">{% fontawesome_icon 'search' color='#336699'%}</button>
      </div>

      <ul id="scope_tabs" class="nav nav-tabs small">
        <li class="nav-item">
        <a class="nav-link active" id="a_idx" data-scope="idx" href="#" role="tab" style="background:#f1fff1;"> Search Index {%fontawesome_icon 'link'%}</a>
        </li>
        <li class="nav-item ml-1">
        <a class="nav-link" id="a_db" data-scope="db" href="#" role="tab" style="background:whitesmoke;">Search Database {%fontawesome_icon 'database'%}</a>
        </li>
      </ul>
      <div id="search_filters" class="tab-pane fade show active" role="tabpanel">
        <span class="filter-header">pre-filters</span>
        <div class="small row">
          <div id="filters_class" class="col-md-12 col-lg-6">
            <p class="mb-0">place categories
            <span class="ml-1">
              <span class="mr-1"><a id="check_toggle" href="#">clear all</a></span>
              <a id="filter_help" class="pointer" data-toggle="popover" title="Place categories" data-content="" tabindex="0" data-trigger="focus">{% fontawesome_icon 'question-circle' color='#336699' %}</a>
            </span>
            </p>
            <ul class="ul-left p-0 mb-0">
            <li class="li-flush"><input type="checkbox" value="A" checked> administrative entities <small>(A)</small></li>
            <li class="li-flush"><input type="checkbox" value="P" checked> cities, towns, hamlets...<small>(P)</small></li>
            <li class="li-flush"><input type="checkbox" value="S" checked> sites, buildings, complexes...<small>(S)</small></li>
            <li class="li-flush"><input type="checkbox" value="R" checked> roads, routes, rail...<small>(R)</small></li>
            <li class="li-flush"><input type="checkbox" value="L" checked> regions, landscape areas <small>(L)</small></li>
            <li class="li-flush"><input type="checkbox" value="T" checked> terrestrial landforms <small>(T)</small></li>
            <li class="li-flush"><input type="checkbox" value="H" checked> water bodies <small>(H)</small></li>
            </ul>
          </div>
          <div id="filters_st" class="col-md-12 col-lg-6">
            <p class="mb-0">temporal ( default = all )
            <span class="float-right">
              <a id="temporal_help" class="pointer" data-toggle="popover" title="Temporal filter" data-content="" tabindex="0" data-trigger="focus">
              {% fontawesome_icon 'question-circle' color='#336699' %}</a></span>
            </p>
            <div>
              <label class="input-sm"><input id="input_start" type="text" value = "" size="12" placeholder="earliest year"></label>
              <label class="input-sm ml-2"><input id="input_end" type="text" value = "" size="12" placeholder="latest year"></label>
            </div>
            <div id="filter_spatial">
            <p class="mb-0">spatial
              <span class="float-right">
              <a id="spatial_help" class="pointer" data-toggle="popover" title="Spatial filter" data-content="" tabindex="0" data-trigger="focus">
              {% fontawesome_icon 'question-circle' color='#336699' %}</a></span>
            </p>
              <label><input id="input_area" type="text" size="30" placeholder="Region, country, study area" /></label>
              <input type="hidden" id="boundsobj" />
            </div>
            <span id="dbicon" class="hidden">{% fontawesome_icon 'database' color='#999' %}</span>
            <div id="search_resets" class="float-right pt-4">
              <span id="reset_search" class="hidden">
                <a href="javascript:resetSearch()">reset search</a></span>
              <span id="reset_filters" class="hidden">
                <a class="ml-3" href="javascript:clearMapFilter()">reset filters</a></span>
            </div>
          </div> <!-- #filters_st -->
        </div> <!-- .row -->
      </div> <!-- #search_filters -->
      <div id="result_filters" class="pt-2 pl-1 hidden">
        <p class="half pl-2 mr-1">result filters {% fontawesome_icon 'filter' %}
        <span id="dropdown_filters">
        <span class="ml-2"><select id="type_select"></select></span>
        <span class="ml-2"><select id="cc_select"></select></span>
        </span>
        </p>
      </div>
      </div><!-- #search_panel -->
      </div>
      <div id="search_right" class="col-sm-6">
        <div id="map_options" class="p-1 small">
        <span id="offer_mapfilter" class="hidden">Draw a bounding box to filter result list</span>
        <span id="clear_mapfilter" class="hidden float-right"><a href="javascript:mappy.fitBounds( features.getBounds())">clear map filter</a></span>
        </div>
        {% leaflet_map "map_search" %}
      </div> <!--#search_right -->
    </div> <!-- .row -->
    <div id="search_lower" class="row">
      <div id="search_info">
        <div class="row p-2">
        <div class="col-sm-6">
          <p class="my-0 strong">Place Search in WHG</p>
          <div id="search_info_blurb">
          <p class="my-0">There are two data stores in WHG, which can be searched independently: a <sr>union index</sr> and a <sr>database</sr>. Data uploaded to WHG is initially stored in a relational database, and records from all datasets flagged as "public" are searchable with the "Search Database" option above. When a dataset is accessioned, its records are added to a union index, where place records asserted as "closely matched" are grouped. The default scope of search is the union index.</p>
          </div>
        </div>
        <div class="col-sm-6 pl-4">
          <img src="{% static 'images/search-figure.svg'%}" style="width:100%; height:auto;" alt=""/>
        </div>
        </div> <!-- .row -->
      </div> <!-- search_info -->
      <div id="type_filter" class="hidden">
        <p class='allcap-heading half mb-0 pl-1'>PLACE TYPES (select to limit)
          <span class="float-right mr-2"><a href="#" class="hide-filter">
            close {% fontawesome_icon 'times-circle' color='#336699' %}</a></span>
          <span class="float-right clear-filter hidden mr-2"><a href="#">restore all</span></a>
        </p>
        <ul class="list-inline"></ul>
      </div>
      <div id='result_title' class='half allcap-heading mb-0 pl-1'></div>
      <div id="result_div" class=""></div>
    </div> <!-- .row -->
  </div>
</div> <!-- .container -->

<div id="ext_site" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
      </div>
      <div id="ext_content" class="modal-body">foo</div>
    </div>
  </div>
</div> <!-- ext_site -->

<script type="text/javascript">
  /* _TOP */
  var initial_layers = null
  var filtered_layers = null
  var shown_layers = null
  var searchres = null
  var features = null

  window.idToArea = {}
  window.area_list = []
  window.area_objs = []

  /* _STATE */
  state = function(){
    stateobj={
      'class':searchClass(), 'scope':searchScope(),
      'rowcount':currentRows()?currentRows().length:0,
      'lyrcount':currentLayers()?currentLayers().length:0,
      'lskeys':ls(),
      'lastresults':lastResult()?lastResult().length:0
    }
    <!--console.log(stateobj)-->
  }
  bboxerActive = function(){
    return bboxer.active
  }
  typeSelect = function(){
    return $("#type_select").val()
  }
  ccSelect = function(){
    return $("#cc_select").val()
  }
  searchClass = function(){
    return $("input[name=class]:checked").val()
  }
  searchScope = function(){
    return !ls('search_scope')||ls('search_scope')=="undefined"?$(".nav-link.active").data('scope'):ls('search_scope')
  }
  currentRows = function(){
    return $("#result_table tbody tr")
  }
  currentLayers = function(){
    return features?L.featureGroup(features._layers):null
  }
  ls = function(key){
    keys=Object.keys(localStorage)
    mykeys = $.grep(keys, function(v) {
      return v.indexOf('mapbox') === -1;})
    return key==null?mykeys:localStorage.getItem(key)
  }
  lastResult = function(){
    return searchres == null?null:searchres
  }
  /* end STATE*/

  // _LOAD
  $(function(){
    /*  if referer is search.html, it's returning from
      viewing a place portal or place detail page
    */
    if(localStorage['keep'] == 'true'){
      $("#search_info").remove()
    }
    search_scope = ls('search_scope')?ls('search_scope'):'idx'
    previous = ls('last_results')
    kept = ls('keep')
    state()
    // remove 'keep' on any nav except place pages
    $('a').show().filter(':not(.place-link, .db-link)').click(function(){
      localStorage.removeItem('keep')
    })
    if(previous && kept=='true'){
      console.log('gonna show previous (last_results)')
    } else {
      $("#input_box").val('')
      localStorage.removeItem('keep')
      localStorage.removeItem('last_results')
    }

    // toggle all fclass checkboxes
    $("#check_toggle").click(function(e){
      e.preventDefault()
      var state = $("#check_toggle").text()
      if(state == 'check all'){
      $("input:checkbox").prop('checked', true);
      $("#check_toggle").text('clear all');
      } else if( state == 'clear all'){
      $("input:checkbox").prop('checked', false);
      $("#check_toggle").text('check all');
      }
    })

    $("#type_select").change(function(){
      term = $(this).val()
      console.log('type selected:', term)
      if(term != "0"){
        $("option").eq(0).text('Restore all')
        typeFilter(term)
        // show clear filters span
        $("#reset_filters").fadeIn()
      } else {
        $("option").eq(0).text('Place type')
        // restore layers, show rows
        restoreInitialLayers()
        $(".search-row").css('display','')
        // hide clear filters span
        $("#reset_filters").fadeOut()
      }
    })
    $("#cc_select").change(function(){
      cc = $(this).val()
      if(cc != "0"){
        $("#cc_select option").eq(0).text('Restore all')
        ccFilter(cc)
        // show clear filters span
        $("#reset_filters").fadeIn()
      } else {
        $("#cc_select option").eq(0).text('Modern country bounds')
        // restore layers, show rows
        restoreInitialLayers()
        $(".search-row").css('display','')
        // hide clear filters span
        $("#reset_filters").fadeOut()
      }
    })

    $("[rel='tooltip']").tooltip();
    $("[data-toggle=popover]").popover({html:true})

    // dynamic dataset info popover
    var dspop = $(".pop-dataset").popover({
      trigger: 'focus',
      placement: 'right',
      html: true
    }).on('show.bs.popover', function () {
      $.ajax({
        url: '/api/datasets/',
        data: {id:$(this).data('id')},
        dataType: "JSON",
        async: false,
        success: function (data) {
          ds=data.results[0]
          console.log('ds',ds)
          html='<p class="thin"><b>Title</b>: '+ds.title+'</p>'
          html+='<p class="thin"><b>Description</b>: '+ds.description+'</p>'
          html+='<p class="thin"><b>WHG Owner</b>: '+ds.owner+'</p>'
          html+='<p class="thin"><b>Creator</b>: '+ds.creator+'</p>'
          dspop.attr('data-content', html);
        }
      });
    })

    // popover content
    $("#filter_help").attr(
      'data-content',"<p>Select one or more place type category (uses GeoNames feature class codes)</p>"
    )
    $("#traces_help").attr(
      'data-content',"<p>An experimental feature: annotations of external web resources that describe or depict historical objects, events, people or concepts, listing places related to them. Switch to learn more and search them.</p>"
    )
    $("#search_help").attr(
      'data-content',"<p class='mb-2'>Search of the WHG <b>index</b> is limited to fully accessioned (linked) datasets. Returns conflated sets of attestations.</p>"+
      "<p>Search of the WHG <b>database</b> includes datasets not yet indexed. Returns individual (non-conflated) attestations.</p>"
    )
    $("#db_help").attr(
      'data-content',"<p>Search of all public datasets, including those not yet indexed. Returns individual (non-conflated) attestations.</p>"
    )
    $("#temporal_help").attr(
      'data-content',"<p>NOTE: Records in our largest core datasets do not have temporal attributes, so the default is all periods. Nevertheless, limiting the timespan here may be useful for some queries</p>"
    )
    $("#spatial_help").attr(
      'data-content',"<p>Constrain search to the bounds of a UN global sub-region</a>, a country, or a user-created study area. Try entering 'south...'</p>"
    ) // <a href='https://unstats.un.org/unsd/methodology/m49/'></a>
    $("#dataset_help").attr(
      'data-content',"<p>Constrain search to indexed places attested in a single public dataset.</p>"
    ) // [<a href='{ url 'public-lists'%}'>list</a>] Choosing a dataset will override spatial filtering.


    var idToFeature = {} // for feature lookup
    var itf_new = []
    var titles = {}
    var searchoption = null;

  // clear map, inputs, results
    $("#type_filter").hide();

    // fetch area list
    $.get("/api/area_list", function(data){
      //console.log('initial areas for list',data)-->
      for(var i=0;i<data.length;i++){
      area_objs.push(data[i])
      area_list.push(data[i]['title'])
      }
    })

    $( "#input_area" ).autocomplete({
      source: area_list,
      minLength: 2,
      select: function( event, ui ) {
      // build boundsobj, insert as hidden input val()
      label = ui.item.label
      obj = area_objs.find(o =>o.title==label)
      areaid = obj.id
      boundsobj = '{"type":["'+obj.type+'"],"id":["'+areaid+'"]}'
      $("#boundsobj").val( boundsobj )
      console.log( "boundsobj for view ", boundsobj);

      // fetch and render selected area
      render_area(areaid)
      }
    });
    $("#input_area").on('keyup', function(e){
      // resets stuff
      if($('#input_area').val().length < 3) {
        $("#boundsobj").val('')
        if(typeof arealayer !== 'undefined'){arealayer.removeFrom(mappy)}
        mappy.setView([38, 10], 2.4)
      }
    })
  }) //  end onLoad()

  hideAllRows = function(){
    currentRows().each(function(r){
      currentRows()[r].style.display='none'
    })
  }
  showAllRows = function(){
    currentRows().each(function(r){
      currentRows()[r].style.display=''
    })
  }
  restoreInitialLayers = function(){
    // show any hidden markers
    for(l in hide_these){hide_these[l].addTo(mappy)}
    mappy.fitBounds(initialLayers.getBounds())
  }

  // hide rows with data-id in 'ids'
  hideRows = function(ids){
    rows = currentRows() // does not include header
    for (i = 0; i < rows.length; i++) {
      _id = parseInt(rows[i].getAttribute('data-id'))
      if (ids.indexOf(_id) > -1){
        rows[i].style.display = "none";
  }}}

  // generates visible_layers[], visible_layerids[]
  visibleFeaturesIds = function() {
    <!--console.trace()-->
    scope = searchScope()  // idx or db
    search_class = searchClass()  // idx or db
    visible_layerids = [];
    visible_layers=[]
    mappy.eachLayer( function(layer) {
      <!--console.log('layer', layer)-->
      if(layer instanceof L.CircleMarker) {
        props=search_class=='place'?layer.feature.geometry.properties:layer.feature.properties
        if(mappy.getBounds().contains(layer._latlng)) {
          // db records have no whgid
          // trace records have props.whg_id
          if(search_class=='trace'){
            visible_layerids.push(Number(props.whg_id))
          } else {
            visible_layerids.push(scope=='idx'?props.whgid:props.pid);
          }
          visible_layers.push(layer)
        }
      } else if (layer instanceof L.Path) {
        props=layer.feature.geometry.properties
        if(mappy.getBounds().contains(layer._latlngs)) {
          visible_layers.push(layer)
          // db records have no whgid
          try {
            visible_layerids.push(scope=='idx'?props.whgid:props.pid);
          } catch (error) {
            console.log('props',props)
            console.log('error',error)
          }
        }
      }
    });
    return visible_layerids;
  }

  /*
    *** ccFilter() ***
    filter result list on change #cc_select
  */
  ccFilter = function(cc){
    results = $("#result_div tbody tr")
    <!--results = $("#result_div tbody tr:visible")-->
    hide_ids=[]; show_ids = []
    for (i = 0; i < results.length; i++) {
      ccodes = results[i].getAttribute('data-ccodes')
      _id = results[i].getAttribute('data-id')

      if (ccodes.indexOf(cc) > -1){
        <!--console.log('SHOW',i,_id, cc, ccodes)-->
        results[i].style.display = "";
        show_ids.push(_id)
      } else if (ccodes.indexOf(cc) == -1) {
        results[i].style.display = "none";
        hide_ids.push(_id)
      }
    }
    console.log('hide_ids',hide_ids)
    console.log('show_ids',show_ids)

    // filter map too
    // layers to hide or show
    hide_these = $.map(hide_ids,function(i){
      return idToFeature[i]
    })
    show_these = $.map(show_ids,function(i){
      return idToFeature[i]
    })
    <!--console.log('hide_these cnt=',hide_these.length)-->
    <!--console.log('show_these cnt=',show_these.length)-->

    window.shown_layers = L.featureGroup(show_these)
    for(l in hide_these){hide_these[l].removeFrom(mappy)}
    for(l in show_these){show_these[l].addTo(mappy)}
    mappy.fitBounds(shown_layers.getBounds())
  }
  /*
    *** typeFilter() ***
    filter result list on change #type_select
  */
  typeFilter = function(term){
    results = $("#result_div tbody tr")
    hide_ids=[]; show_ids = []
    for (i = 0; i < results.length; i++) {
      types = results[i].getAttribute('data-types')
      _id = results[i].getAttribute('data-id')
      if (types.indexOf(term) > -1){
        console.log('SHOW',i,_id, term, types)
        results[i].style.display = "";
        show_ids.push(_id)
      } else if (types.indexOf(term) == -1) {
        <!--console.log('HIDE',i,_id, term, types)-->
        results[i].style.display = "none";
        hide_ids.push(_id)
      }
    }
    console.log('show_ids', show_ids)
    // filter map too
    hide_these = $.map(hide_ids,function(i){
      return idToFeature[i]
    })
    show_these = $.map(show_ids,function(i){
      return idToFeature[i]
    })
    console.log('show_these', show_these)

    shown_layers = L.featureGroup(show_these)
    console.log('shown_layers', shown_layers._layers)
    for(l in hide_these){hide_these[l].removeFrom(mappy)}
    for(l in show_these){show_these[l].addTo(mappy)}
    <!--return-->
    // this does a zoom, triggering mappy.on('zoomend')
    mappy.fitBounds(shown_layers.getBounds(), {padding:[100,100]})
    <!--mappy.fitBounds(shown_layers.getBounds())-->
  }
  /*
    *** mapFilter() ***
    filter result list on zoomend
    TODO:
    1) remove all map layers, add back those in view
    2) remove result_div rows, don't just hide them
  */
  mapFilter = function(boxed_ids){
    $(".clear-filter").show()

    <!--if(filtered_layers != null){filtered_layers.addTo(mappy)}-->

    ids_boxed=boxed_ids
    // arrays of mappable results
    ids_all = Object.keys(idToFeature).map(Number);
    ids_hide = ids_all.filter(x => ids_boxed.indexOf(x) === -1);
    ids_show = ids_all.filter(x => ids_boxed.indexOf(x) > -1);

    // filter features/layers
    features.clearLayers();
    currentLayers().forEach(function(l){
      var gprops = l.feature.geometry.properties
      if(gprops){
        _id = search_scope == 'idx'?gprops.whgid:gprops.pid
        // if feature in bbox, add its layer back
        if(ids_show.indexOf(_id) > -1){
          features.addLayer(idToFeature[gprops.whgid])
        }
      }
    });

    // hide result rows not in bbox
    results = $("#result_div tbody tr")
    // for each result row, if its id is in hidethese, hide it
    for (i = 0; i < results.length; i++) {
      _id = parseInt(results[i].getAttribute('data-id'))
      if (ids_hide.indexOf(_id) > -1){
        results[i].style.display = "none";
      } else {
        results[i].style.display = ""
      }
    }

    <!--console.log('hidden in list)', hidethese)-->
    // omit header row
    $("#rowcount").html((results.length-1) - ids_hide.length)
    // if any were hidden, show the zoom_extents link to restore
    if(ids_hide.length > 0){
      $("#clear_mapfilter").fadeIn()
    } else { $("#clear_mapfilter").fadeOut()}
  }

  resetSelects = function(){
    $("#cc_select").val(0)
    $("#cc_select option").eq(0).text('Modern country bounds')
    $("#type_select").val(0)
    $("#type_select option").eq(0).text('Place type')
  }
  /*
    *** clearMapFilter() ***
    restores all search result features
  */
  clearMapFilter = function(){
    // display all result rows
    <!--console.log('need to restore all', ids_all)-->
    for (i = 0; i < results.length; i++) {
      results[i].style.display = ""
    }
    // restore all map layers
    <!--console.log('ids_all',ids_all)-->
    <!--$.each(ids_all, function(i){-->
    $.each(hide_these, function(i){
    <!--$.each(idToFeature, function(i){-->
      <!--features.addLayer(idToFeature[hide_these[i]])-->
      mappy.addLayer(hide_these[i])
    })
    mappy.fitBounds(features.getBounds())
    // hide link, reset selects, recalc # rows
    $("#reset_filters").hide()
    resetSelects()
    <!--$("#cc_select").val(0)-->
    <!--$("#cc_select option").eq(0).text('Modern country bounds')-->
    <!--$("#type_select").val(0)-->
    <!--$("#type_select option").eq(0).text('Place type') -->
    $("#rowcount").html((results.length))

  }

/*
  *** sortTable() ***
  col_idx == index of column to sort by
  */
  sortTable = function(col_idx, order) {
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById("result_table");
    switching = true;
    /* Make a loop that will continue until
    no switching has been done: */
    while (switching) {
      // Start by saying: no switching is done:
      switching = false;
      rows = table.rows;
      /* Loop through all table rows (except the
      first, which contains table headers): */
      for (i = 1; i < (rows.length - 1); i++) {
        // Start by saying there should be no switching:
        shouldSwitch = false;
        /* Get the two elements you want to compare,
        one from current row and one from the next: */
        x = rows[i].getElementsByTagName("TD")[col_idx];
        y = rows[i + 1].getElementsByTagName("TD")[col_idx];
        // Check if the two rows should switch place:
        if (order == 'asc'){
          if (x.innerText.toLowerCase() > y.innerText.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        } else {
          if (x.innerText.toLowerCase() < y.innerText.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        /* If a switch has been marked, make the switch
        and mark that a switch has been done: */
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }
/*
  *** render_area() ***
  fetch and display an area (region/area/country)
*/
  render_area = function(areaid) {
    $.ajax({
      url: '/api/area/'+areaid
      }).done(function(data){
      console.log('render_area()',data)
      geom = {"type":"FeatureCollecton","features":[]}
      geom['features'].push(data.geojson)

    // clear existing
    if(typeof arealayer !== 'undefined'){arealayer.removeFrom(mappy)}

    // render new
    arealayer = L.geoJSON(geom, {
      onEachFeature: function(feature,layer) {
      f=feature; l=layer;
      console.log('render_area() f,l',f,l)
      l.setStyle({"color":"orange","weight":2,"fillOpacity":0})
      idToArea[areaid] = l
      <!--identifier = f.place_id;-->
      popupOptions = {maxWidth: 200};
      l.bindPopup(data.title, popupOptions);
      }
    }).addTo(mappy)
    mappy.fitBounds(arealayer.getBounds())
    })
  }
  //
  // DEPRECATED, no heat here
  {#heat = function(dataset) {#}
  {#  console.log('heat()',dataset)#}
  {#  ne_global.getMapboxMap().addLayer({#}
  {#  "id": "heat_active",#}
  {#  "type": "heatmap",#}
  {#  "source": dataset,#}
  {#  "maxzoom": 9,#}
  {#  "paint": {#}
  {#    // Increase the heatmap weight based on frequency and property magnitude#}
  {#  "heatmap-weight": [#}
  {#    "interpolate",#}
  {#    ["linear"],#}
  {#    ["get", "mag"],#}
  {#    0, 0,#}
  {#    6, 1#}
  {#  ],#}
  {#  // Increase the heatmap color weight weight by zoom level#}
  {#  // heatmap-intensity is a multiplier on top of heatmap-weight#}
  {#  "heatmap-intensity": [#}
  {#    "interpolate",#}
  {#    ["linear"],#}
  {#    ["zoom"],#}
  {#    0, 1,#}
  {#    9, 3#}
  {#  ],#}
  {#  // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).#}
  {#  // Begin color ramp at 0-stop with a 0-transparancy color#}
  {#  // to create a blur-like effect.#}
  {#  "heatmap-color": [#}
  {#    "interpolate",#}
  {#    ["linear"],#}
  {#    ["heatmap-density"],#}
  {#    0, "rgba(33,102,172,0)",#}
  {#    0.2, "rgb(103,169,207)",#}
  {#    0.4, "rgb(209,229,240)",#}
  {#    0.6, "rgb(253,219,199)",#}
  {#    0.8, "rgb(239,138,98)",#}
  {#    1, "rgb(178,24,43)"#}
  {#  ],#}
  {#  // Adjust the heatmap radius by zoom level#}
  {#  "heatmap-radius": [#}
  {#    "interpolate",#}
  {#    ["linear"],#}
  {#    ["zoom"],#}
  {#    0, 2,#}
  {#    9, 20#}
  {#  ],#}
  {#  // Transition from heatmap to circle layer by zoom level#}
  {#  "heatmap-opacity": [#}
  {#    "interpolate",#}
  {#    ["linear"],#}
  {#    ["zoom"],#}
  {#    7, 1,#}
  {#    9, 0#}
  {#  ],#}
  {#  }#}
  {# });#}
  {# }#}
  {##}

  //
  // initializes map
  addEventListener('map:init', function (e) {
    window.mappy = e.detail.map
    mappy.setMaxBounds(null)
    mappy.options.zoomSnap = 0.5
    mappy.options.maxZoom = 6
    mappy.setView(new L.LatLng(32, 12.6), 1);

    // mapbox tokens
    var token_whg = '{{ mbtoken }}'
			{#,token_mb = '{{ mbtoken }}'#}
      {#,token_kg = '{{ mbtoken }}';#}

  // style/tile urls
    var mbstyle_url = 'https://api.mapbox.com/styles/v1/{id}/tiles/256/{z}/{x}/{y}?access_token={token}',
      mbtiles_url = 'https://api.mapbox.com/v3/{id}/{z}/{x}/{y}.png',
      ne_url = 'http://blog.whgazetteer.org/tiles/ne/{z}/{x}/{y}.png';

    var satellite  = L.tileLayer(mbstyle_url, {
      id:'mapbox/satellite-streets-v11',
      token:token_whg})
    var osm  = L.tileLayer(mbstyle_url, {
      id:'mapbox/light-v10',
      token:token_whg})

    //
    mb_terrain = L.mapboxGL({
      style:'mapbox://styles/kgeographer/ckhf6o8yf07fw19qhbrm7f2q7',
      accessToken:token_whg})

    ne_global= L.mapboxGL({
      style:'mapbox://styles/kgeographer/ckidglq8l2nra19nzzbl995ue',
      accessToken:token_whg}).addTo(mappy)

    var countryStyle = {
      "color": "yellow",
      {#"color": "#999",#}
      "weight": 1,
      "opacity": 0.4,
      "fillOpacity": 0
    };

    <!--countries = new L.GeoJSON.AJAX("/media/data/countries_simplified.json",-->
    // build a hash for cc_select
    <!--cchash = new Object-->
    countries = new L.GeoJSON.AJAX("/media/data/countries_noantarctica.json",
      {style:countryStyle,
        onEachFeature: function (feature, layer) {
          cc = feature.properties.iso
          label = feature.properties.gnlabel
          popupOptions = {maxWidth: 200};
            layer.bindPopup(feature.properties.gnlabel, popupOptions);
          }
    });


    var baseLayers = {
      "NE global": ne_global,
      "Terrain": mb_terrain,
      "OpenStreetMap": osm,
      "Satellite": satellite
    };
    var dataLayers = {
      "Countries": countries,
      <!--"Regions (UN)": regions-->
    }
    mappy.zoomControl.setPosition('topright')

    bboxer = L.Control.boxzoom(
      { position:'topleft',
        title:'Select tool, then draw rectangle to filter results',
        enableShiftDrag: true
        // iconClasses:['bbox-icon']
      })

    // startup controls only
    L.control.layers(baseLayers, dataLayers).addTo(mappy);
    baseLayers["NE global"].addTo(mappy)

    // TODO:
    // much is duplicated here from typeFilter() and ccFilter()
    // a big combinatorial state challenge
    mappy.on('zoomend',function(e){
      /*  none of this should happen if not places and no features
        (apart from countries or areas have loaded)
      */
      if(typeof idToFeature != 'undefined' && searchClass()=='place' && search_scope == 'idx'){      // the result list
        results = $("#result_div tbody tr")
        // get layer ids
        all_ids = Object.keys(idToFeature).map(Number)
        show_ids = visibleFeaturesIds(search_scope)
        hide_ids = all_ids.filter(value=>!show_ids.includes(value))
        // get leaflet layers themselves
        hide_these = $.map(hide_ids,function(i){
          return idToFeature[i]
        })
        show_these = $.map(show_ids,function(i){
          return idToFeature[i]
        })

        window.shown_layers = L.featureGroup(show_these)
        for(l in hide_these){hide_these[l].removeFrom(mappy)}
        for(l in show_these){show_these[l].addTo(mappy)}

        // hide rows for hidden map layers
        for (i = 0; i < results.length; i++) {
          _id = Number(results[i].getAttribute('data-id'))
          if (hide_ids.indexOf(_id) > -1){
            results[i].style.display = "none";
          } else if (show_ids.indexOf(_id) > -1) {
            results[i].style.display = "";
          }
        }
        // recalc visible rows total
        $("#rowcount").html((results.length) - hide_ids.length)
        // zoomend filtered, show 'reset filters' link
        if(show_ids.length < all_ids.length){
          $("#reset_filters").fadeIn()
        } else {$("#reset_filters").hide()}

        <!--console.log('zoomend visible: '+show_ids+'; all: '+all_ids)-->
        <!--console.log('zoomend hide these '+ hide_ids)-->
      } else if (searchClass()=='trace' && bboxer.map ) {
        <!--console.log('need to filter result list here')-->
        results = $("#result_div tbody tr")
        //results = $("#result_div tbody tr").filter(function(i){return $( this ).attr( "data-id" ) != "none"}) -->

        all_ids = Object.keys(idToFeature).map(Number)

        show_ids = visibleFeaturesIds(search_scope)
        hide_ids = all_ids.filter(value=>!show_ids.includes(value))
        for (i = 0; i < results.length; i++) {
          _id = Number(results[i].getAttribute('data-id'))
          // if (isNaN(_id) || hide_ids.indexOf(_id) > -1 ){-->
          if (hide_ids.indexOf(_id) > -1 ){
            results[i].style.display = "none";
          } else if (show_ids.indexOf(_id) > -1 ) {
            results[i].style.display = "";
          }
        }
        if(results.is(':visible')){
          sortTable(2, 'asc')
        }
      }
    })


    if(ls('last_results') != null){
      kept = ls('keep')
      previous = JSON.parse(ls('last_results'))
      console.log('got previous')
      if( kept == "true" && previous){
        showResults(previous,'place','search')
      }
      // don't stop keeping after one nav away
      <!--localStorage.setItem('keep', false)-->
    }
  }, false); <!-- addEventListener() -->

  {#cleanJson = function(text) {#}
  {#  z=text.replace(/'/g,'\\"')#}
  {#  y=z.replace(/point/,'Point')#}
  {#  return JSON.parse(JSON.parse(y))#}
  {# }#}

  styles_bbox = {
    "MultiPolygon": {
      "default":{fillOpacity: 0.3, opacity: 1, color: "#000", weight: 1, fillColor:"#ff9999"},
      "focus":{fillOpacity: 0.3, opacity: 1, color: "red", weight: 2, fillColor:"#ff9999"}},
    "Polygon": {
      "default":{fillOpacity: 0.3, opacity: .5, color: "#666", weight: 1, fillColor:"#ff9999"},
      "focus":{fillOpacity: 0.3, opacity: .5, color: "red", weight: 2, fillColor:"#ff9999"}}
  }

  //  triggerEvent(window, 'map:init', {id: id, map: map, options: options});

  filly = function(counter) {
    if (counter == 0)
      return "blue"
    else if (counter == 1)
      return "orange"
    else if (counter == 2)
      return "purple"
    else if (counter == 3)
      return "greenyellow"
    else
      return "yellow"
  }


  // clear results, type filter
  /*
    *** searchPlacesIdx() *** from #input_box keyup
    index search w/o autocomplete -> showResults()
  */
  searchPlacesIdx = function (){
    //console.log('searchPlacesIdx()',search_scope)
    // get filter values: fclasses, start, end, ??
    fclasses = [];
    $('#search_filters input:checked').each(function() {
      fclasses.push($(this).val());
    });
    {#console.log('fclasses', fclasses)#}
    index = 'whg'
    // clear filters
    $(".list-inline").html('')
    // console.log('bounds in js SearchPlacesIdx()',$("#boundsobj").val())-->
    $.get("/search/index",{
      qstr: $('#input_box').val(),
      idx: index,
      fclasses: fclasses.join(','),
      start: $("#input_start").val(),
      end: $("#input_end").val(),
      bounds: $("#boundsobj").val()
      }, function(data){
        window.searchres = data['suggestions']
        window.session = data['session']
        // store locally
        localStorage.setItem('last_results',JSON.stringify(searchres))
        // render to html
		    showResults(searchres);
      }
    );
    $('.tt-menu').hide()
  }

  /*
    *** searchPlacesDb() *** from #input_box keyup
    database search w/o autocomplete -> showResults()
  */
  searchPlacesDb = function(){
    <!--console.log('searchPlacesDb()',search_scope)-->
    startSearchSpinner()
    fclasses = [];
    $('#search_filters input:checked').each(function() {
      fclasses.push($(this).val());
    });
    years = [Number($("#input_start").val()),Number($("#input_end").val())]
    y = years.find(element => element != 0 );
    {#ds_select = $("#select_ds_search").val()#}
    {#dsid = ds_select!="0" ? parseInt(ds_select) : null#}
    $.get("/search/db",{
      name: $('#input_box').val(),
      name_contains: null, // if 'contains' checked
      // break array nec. - WHY???
      fclasses: fclasses.join(','),
      year: !y?null:y,
      dsid: null,
      context: "search",
      bounds: $("#boundsobj").val()
    }, function(data) {
      window.searchres=data['suggestions']
      // store locally
      localStorage.setItem('last_results',JSON.stringify(searchres))
      showResults(searchres, doctype, "search")
      spinner_search.stop()
    })
  }
  /*
    *** showResults() ***
    from searchPlacesIdx(), searchPlacesDb(), fetchTraceGeometry()
    Builds results_div, renders to #result_div; builds geoms[] -> renderPlaces(geoms)

    data: list of objects
    doctype ['place' | 'trace' ]
    scope: ['suggest' | 'search']
    title:
  */
  showResults = function(data, title){
    console.log('showResults() data length', data.length)
	  $(".spinner").remove()
    // always want result_div to show
    $("#result_div").show()
    var results_div = '';
    var result_table = '';
    search_scope = searchScope()
    // ensure correct tab is selected
    geoms=[]
    var types=[], typesArr = [], ccArr = []
    if(data.length == 0) {
      results_div += '<p class="small ml-2">No results, sorry. Try database search for records that are not yet indexed</p>'
    } else {
      result_table ='<table id="result_table" class="tableFixHead"><thead><tr>'
      +'<th>Title <i class="fa fa-sort ml-1" data-id=0 ref=asc></i></th>'
      +(search_scope=='idx'?'<th>Linked <i class="fa fa-sort ml-1" data-id=1 ref=desc></i></th>':'')
      +'<th>Countries&nbsp;<i class="fa fa-sort small" data-id='
      +(search_scope=='idx'?2:1)+' ref=asc></i></th>'
      +(search_scope=='idx'?'':'<th>Dataset <i class="fa fa-sort ml-1" data-id=2 ref=asc></i></th>')
      +'<th>Type(s)</th><th>Name variants</th><th>geom?</th> </tr></thead>'

      countadded = 0
      havegeom = 0

      data.forEach(function(sug){
        typesArr=typesArr.concat(sug.types)
        ccArr=ccArr.concat(sug.ccodes)

        if(!!sug.geom) {
          havegeom +=1
          sug.geom.forEach(function(g){
            g['properties']['title'] = sug.name
            g['properties']['whgid'] = sug.whg_id
            {#g['properties']['whgid'] = (doctype=='place')?sug.whg_id:sug.place_id#}
            geoms.push(g)
          })
        }
        // adds a row to result_div that gets inserted into #result_div later
        //result_table += sugLister(sug, doctype, scope)
        result_table += sugLister(sug)
        countadded +=1
        // result_table += sugTableRow(sug, doctype, scope)   -->
      })
      result_table += '</table>'
      // console.log('showResults() countadded, havegeom',countadded, havegeom)-->

      // list of distinct types
      types = Array.from(new Set(typesArr));
      // TODO: on zoomend, any geoms in viewport are added to result_div
      // into select dropdown
      $('#type_select').empty();
      $('#type_select').append('<option value="0">Place type</option>');
      $.each(types, function(i, p) {
        $('#type_select').append($('<option></option>').val(p).html(p));
      });

      countries = Array.from(new Set(ccArr));
      $('#cc_select').empty();
      $('#cc_select').append('<option value="0">Modern country bounds</option>');
      $.each(countries, function(i, p) {
        // look up country name, least we can do!
        cName = ccode_hash[p]['gnlabel']
        $('#cc_select').append($('<option></option>').val(p).html(cName+' ('+p+')'));
      });

      renderPlaces(geoms)
      if(data.length > 1){$("#result_filters").show()}
    }

    if(searchClass() == 'place' && searchScope() == 'idx' && (data.length > 3 || mappy.getZoom() < 5)){
      $("#offer_mapfilter").fadeIn()
      if (bboxer._map == undefined ){ bboxer.addTo(mappy); }
    }
    $("#result_div").show()
    $("#reset_search").show()
    $("#search_info").hide()

    let src = search_scope=='idx'?'UNION INDEX':'DATABASE'
    let elem = document.getElementById('result_div')

    titleMarkup = src+' SEARCH RESULTS (<span id="rowcount">'+
		    data.length+'</span>)<span class="ml-4">List may include records with no geometry</span>'

    $("#result_title").html(titleMarkup)
    $("#result_title").fadeIn()

    $("#result_div").html(result_table)

    $(".fa-sort").on('click',function(){
      fubar = $(this)
      sortTable($(this).data('id'), $(this).attr('ref'))
    })

    let headerbg = search_scope=='idx'?'#f1fff1':'#eee'
    $("#result_table th").css('background-color', headerbg )

    // empty the typeahead suggestions
    $(".tt-dataset").html('')


    $(".trace-item").on('click',function(e){
      // reset all markers to default
      traces.setStyle({"fillColor":"blue","radius":5})
      whgid = $(this).attr('data-id')
      console.log(whgid,'from body-place click')
      if(whgid in idToFeature) {
        idToFeature[whgid].setStyle({"fillColor":"#ff3333","radius":10})
        mappy.panTo(idToFeature[whgid]._latlng)
      } else {
        h = $(this).html()
        h += '...<b>no geometry yet</b>'
        $(this).html(h)
      }
    })

    // highlight map marker from list
    $(".search-row").on('click',function(e){
      // identifier either a whgid (index search) or pid (db search)
      layerid = $(this).data('id')
      {#console.log('search-row click', layerid)#}

      f = $(this).data('id') !='none'?idToFeature[layerid]:null
      // if there's a feature, highlight it
      if(f){
        // set all to white
        $(".search-row").css('background-color','#fff')
        // then highlight this one
        $(this).css('background-color','#f4f4d7')
        // fetch record detail and put it in #result_extra
        // set all layers to default style
        for (i in idToFeature){
          type = idToFeature[i].feature.geometry.type
          idToFeature[i].setStyle(type=='Point'?styles.marker_default:styles.line_default)
        }
        // raise z-index
        f.bringToFront().setStyle(f.feature.geometry.type=='Point'?styles.marker_highlight:styles.line_highlight)
        // get a centroid
        center = f.feature.geometry.type=='Point' ? f._latlng : f.getCenter(f._latlngs)
        mappy.panTo(center)
      } else {
        clickedrow = $(this)
        console.log(clickedrow)
      }
    })
    // open a modal for external page
    $('.ext').on('click', function(e) {
      e.preventDefault();
      var url = $(this).attr('href');
      console.log('url',url)
      $(".modal-body").html('<iframe width="100%" height="100%" frameborder="0" scrolling="yes" '+
        'allowtransparency="true" src="'+url+'"></iframe>');
    });

  } // end showResults()

  /*
    *** renderPlaces() ***
    from showResults()
    renders geometries from search results to map
  */
  renderPlaces = function(geoms) {
    if(features){ features.clearLayers() }
    if(typeof(traces)!=='undefined'){ traces.clearLayers() }

    featcoll = {"type":"FeatureCollection","features":geoms}
    // console.log('geodata prior to render',data)
    var count_features = 0
    idToFeature = {}
    idToArea = {}
    mappy.createPane('placePane');
    mappy.getPane('placePane').style.zIndex = 200;

    initialLayers = new L.featureGroup()
    features = L.geoJSON(featcoll, {
      pointToLayer: function (feature, latlng) {
        count_features +=1;
        // if feature has src key, it's from a database search
        identifier = feature.src ? feature.properties.pid : feature.properties.whgid;
				// all geometry added from wikidata matches is MultiPoint...for some reason
        if(feature.type.indexOf('Point') > -1){
          marker = L.circleMarker(latlng, styles.marker_default)
          // add to array for selection
          idToFeature[identifier] = marker
          return marker
        }
      },
      onEachFeature: function(feature,layer) {
        f=feature; l=layer;
        // if feature has src key, it's from a database search; also, popup link differs
        if(feature.src){
          identifier = feature.properties.pid
          popup_link = ' (<a href="/places/'+identifier+'/detail">place page</a>)'
        } else {
          identifier = feature.properties.whgid
          popup_link = ' (<a href="/places/'+identifier+'/portal">place portal</a>)'
        }
        if(feature.type != 'Point'){
          layer.setStyle(['LineString','MultiLineString'].indexOf(feature.type)>-1 ? styles.line_default:styles.pgon_default)
          idToFeature[identifier] = layer
        }
        layer.bindPopup(feature.properties.title);

        // find row in results and highlight it
        layer.on('click',function(e){
          scroll = 20
          ele = $("#result_div")
          // set all to white background
          $(".search-row").css('background-color','#fff')

          fid = search_scope=='idx'?this.feature.geometry.properties.whgid:this.feature.geometry.properties.pid

          foo=$("tr.place-item").find('[data-id="'+fid+'"]').closest('.search-row')
          foo.css('background-color','#f4f4d7')
          foo[0].scrollIntoView()
          ele.scrollTop(ele.scrollTop() - scroll);
        })
        //
        initialLayers.addLayer(layer)
      }
    }).addTo(mappy); <!-- adds features L.geoJSON -->

    bounds = features.getBounds()
    if(geoms.length > 0 ){
      mappy.fitBounds(bounds)
      if(mappy.getZoom() > 5){ mappy.setZoom(5)}
    }
  }
  /*
    *** sugLister() ***  from showResults()
    formats search result item (sug)
  */
  function sugLister(sug) {
  //function sugLister(sug, doctype, scope) {
		{#console.log('sug', sug)#}
    // this is count of children[]; add 1 to include self
    linkcount = parseInt(sug['linkcount']) +1
    attestations = sug['ds'] ? '' : ' <i>' + linkcount +
		    (linkcount>1?' linked attestations</i>; ':' attestation</i>; ')
    vcount = sug['variants'].length
    variants = vcount > 0 ? sug['variants'].sort().slice(0,6).join('; ') : ''
    ccodes = sug['ccodes'] != '' ? ' '+sug['ccodes']+' ' : ''
    types = sug['types'].join('; ')
    geo = sug['geom'].length > 0 ? ' {% fontawesome_icon 'globe' color='#666' %}' : ''
    // whgid if index search, else pid
    identifier = sug['ds'] ? sug['pid'] : sug['whg_id']
    dsid = sug['ds'] ? parseInt(sug['ds']['id']) : ''
    // add dataset link if this is db search result
    if(sug['ds']){
      dslink = dsid != 394 ? '<a href="#" class="ds-link" data-id='+dsid+'>'+
		      sug['ds']['title']+'</a>': sug['ds']['title']
    } else {
      dslink = ''
    }
    // link destination varies
    link_class = sug['ds'] ? 'db-link' : 'place-link'
    variants = vcount > 5 ? variants +' ... <i>'+vcount+' total</i>' : variants

    // table row
    item = '<tr class="search-row place-item" data-id="'+identifier
    +'" data-types="'+sug['types']
    +'" data-ccodes="'+ccodes
    +'">'
    +'<td><a class="'+link_class+'" href="#" data-id="'+identifier+'"><b>'+sug['name']+'</a></td>'
    +(sug['ds'] ? '': '<td>'+linkcount+'</td>')
    +'<td>'+ccodes+'</td>'
    +(sug['ds'] ? '<td>'+dslink+'</td>' : '')
    +'<td>'+types+'</td>'
    +'<td>'+variants+'</td>'
    +'<td class="text-center">'+geo+'</td></tr>'

    return item
  }
  // DEPRECATED; from sugLister()
  {#function parseRels(rels){#}
  {#  html=''#}
  {#timespans=[]; starts=[]; ends=[]#}
  {#  for(r in rels){#}
  {#  html += rels[r].relation#}
  {#  for(w in rels[r].when){#}
  {#  timespans.push(rels[r].when[w])#}
  {# }}#}
  {#reg = /(-?\d{1,4})\D?/#}
  {#for (t in timespans){#}
  {#  // no 'in', 'earliest' or 'latest' here#}
  {#  starts.push(Number(timespans[t].start.match(reg)[1]))#}
  {#  ends.push(!!timespans[t].end ? Number(timespans[t].end.match(reg)[1]) : -1)#}
  {# }#}
  {#<!--console.log('starts',starts,'ends',ends)-->#}
  {#minmax=' ['+[starts.length>0?Math.max.apply(null, starts):'-',ends.length>0?Math.max.apply(null, ends):'-']+']'#}
  {#if(!starts.length==0 && !ends.length==0){ html += minmax}#}
  {#  return html#}
  {# }#}

  // DEPRECATED; from sugLister()
  {#function parseWhen(when){#}
    {#console.log('parseWhen()',when)#}
  {#  html=''#}
  {#  for (w in when){#}
  {#    s = 'start' in when[w]?'start: '+when[w]['start']:'earliest: '+when[w]['earliest']#}
  {#    e = 'end' in when[w]?'end: '+when[w]['end']:'latest: '+when[w]['latest']#}
  {#    html += s +", " +e#}
  {#    html+=w==when.length-1?'':'; '#}
  {#  }#}
  {#  return html#}
  {# }#}

  // from parserPlace() builds link for external place record
  // DEPRECATED
  {#function url_extplace(identifier) {#}
  {#  // abbreviate links not in aliases.base_urls#}
  {#  if(identifier.startsWith('http')) {#}
  {#    let tag = identifier.replace(/.+\/\/|www.|\..+/g, '')#}
  {#    link = '<a href="'+identifier+'" target="_blank">'+tag+#}
	{#	      '{% fontawesome_icon 'external-link' color='#336699' %},  </a>'#}
  {#  } else {#}
  {#  link = '<a href="" class="ext" data-target="#ext_site">'+identifier+#}
	{#	    '&nbsp;{% fontawesome_icon 'external-link' color='#336699' %}</a>, '#}
  {#  }#}
  {#  return link#}
  {# }#}

  // from parsePlace() builds link for external placetype record
  // DEPRECATED
  {#function url_exttype(type) {#}
  {#  link = ' <a href="#" class="exttab" data-id='+type.identifier+#}
  {#    '>('+type.label+' {% fontawesome_icon 'external-link' color='#336699' %})</a>'#}
  {#  return link#}
  {# }#}

  // parse most data from a Place object
  // DEPRECATED
  {#function parsePlace(data) {#}
  {#  window.featdata = data#}
	{##}
  {#  function onlyUnique(array) {#}
  {#    const map = new Map();#}
  {#    const result = [];#}
  {#    for (const item of array) {#}
  {#      if(!map.has(item.identifier)){#}
  {#        map.set(item.identifier, true);#}
  {#        result.push({#}
  {#          identifier: item.identifier,#}
  {#          type: item.type,#}
  {#          aug: item.aug#}
  {#        });#}
  {#      }#}
  {#    }#}
  {#    return(result)#}
  {#  }#}
  {#  //#}
  {#  // TITLE#}
  {#  descrip = '<p><b>Title</b>: <span id="row_title" class="larger text-danger">'+data.title+'</span>'#}
  {#  //#}
  {#  // DATASET#}
  {#  descrip+='<p><b>Dataset</b>: '+data.dataset + ' ('+data.id+')'#}
  {#  //#}
  {#  // NAME VARIANTS#}
  {#  descrip+='<p class="scroll65"><b>Variants</b>: '#}
  {#  for (n in data.names) {#}
  {#    let name = data.names[n]#}
  {#    descrip+= '<p>'+name.toponym !=''?name.toponym+'; ': ''#}
  {#  }#}
  {#  //#}
  {#  // TYPES#}
  {#  // may include sourceLabel:"" **OR** sourceLabels[{"label":"","lang":""},...]#}
  {#  descrip+='</p><p><b>Types</b>: '#}
  {#  typeids = ''#}
  {#  for (t in data.types) {#}
  {#    str = ''#}
  {#    var type = data.types[t]#}
  {#    if('sourceLabels' in type){#}
  {#      srclabels = type.sourceLabels#}
  {#      for(l in srclabels){#}
  {#        label = srclabels[l]['label']#}
  {#        str = label !='' ? label + '; ' : ''#}
  {#      }#}
  {#    } else if ('sourceLabel' in type) {#}
  {#      str = type.sourceLabel !='' ? type.sourceLabel + '; ' : ''#}
  {#    }#}
  {#    if(type.label!=''){ str += url_exttype(type) + ' ' }#}
  {#    typeids+=str#}
  {#  }#}
  {#  descrip += typeids.replace(/(; $)/g, "") +'</p>'#}
	{##}
  {#  //#}
  {#  // LINKS#}
  {#  //#}
  {#  descrip += '<p class="mb-0"><b>Links</b>: <i>original: </i>'#}
  {#  close_count = added_count = related_count = 0#}
  {#  html_close = html_added = html_related = ''#}
  {#  if (data.links.length > 0) {#}
  {#    links=data.links#}
  {#    links_arr = onlyUnique(data.links)#}
  {#    <!--console.log('distinct data.links',links_arr)-->#}
  {#    for (l in links_arr) {#}
  {#      if (links_arr[l].aug == true) {#}
  {#        added_count +=1#}
  {#        html_added += url_extplace(links_arr[l].identifier)#}
  {#      } else {#}
  {#        close_count +=1#}
  {#        html_close+=url_extplace(links_arr[l].identifier)#}
  {#      }#}
  {#    }#}
  {#    descrip += close_count > 0 ? html_close : 'none; '#}
  {#    descrip += added_count > 0 ? '<i>added</i>: '+html_added : '<i>added</i>: none'#}
  {#  } else { descrip += "<i class='small'>no links established yet</i>" }#}
  {#  descrip += '</p>'#}
	{##}
  {#  //#}
  {#  // RELATED#}
  {#  if (data.related.length > 0) {#}
  {#    parent='<p class="mb-0"><b>Parent(s)</b>: ';#}
  {#    related='<p class="mb-0"><b>Related</b>: ';#}
  {#    for (r in data.related){#}
  {#      rel = data.related[r]#}
  {#      if (rel.relation_type == 'gvp:broaderPartitive'){#}
  {#        parent += '<span class="h1em">'+rel.label#}
  {#        parent += 'when' in rel && !('timespans' in rel.when) ?#}
  {#          ', '+rel.when.start.in+'-'+rel.when.end.in :#}
  {#          'when' in rel && ('timespans' in rel.when) ? ', '+#}
  {#            minmaxer(rel.when.timespans) : ''#}
  {#        parent += '</span>; '#}
  {#      }#}
  {#      else {#}
  {#        related += '<p class="h1em">'+rel.label+ ', '+rel.when.start.in+'-'+rel.when.end.in+'</p>'#}
  {#      }#}
  {#    }#}
  {#    descrip+=parent.length > 39 ? parent :''#}
  {#    descrip+=related.length > 37 ? related :''#}
  {#  }#}
  {#  //#}
  {#  // DESCRIPTIONS#}
  {#  // TODO: link description to identifier URI if present#}
  {#  if (data.descriptions.length > 0 ) {#}
  {#    <!--val = data.descriptions[0]['value'].substring(0,300)-->#}
  {#    val = data.descriptions[0]['value']#}
  {#    if(val != undefined){#}
  {#      descrip+='<p><b>Description</b>: '+(val.startsWith('http')?'<a href="'+val+'" target="_blank">Link</a>':val)#}
  {#      +' ... </p>'#}
  {#    }#}
  {#  }#}
  {#  //#}
  {#  // CCODES#}
  {#  //#}
  {#  <!--if (data.ccodes.length > 0) {-->#}
  {#  if (!!data.countries) {#}
  {#    <!--console.log('data.countries',data.countries)-->#}
  {#    descrip+='<p><b>Modern country bounds</b>: '+ data.countries.join(', ')+'</p>'#}
  {#  }#}
  {#  //#}
  {#  // MINMAX#}
  {#  //#}
  {#  if(data.minmax && data.minmax.length>0){#}
  {#    descrip += '<p><b>When</b>: earliest: '+data.minmax[0]+'; latest: '+data.minmax[1]#}
  {#  }#}
  {#  descrip += '</div>'#}
  {#  return descrip#}
  {# }#}

  // put a place record in #result_extra
  // DEPRECATED
  {#function getPlace(pid){#}
  {#  <!--console.log('getPlace() - why???', pid)-->#}
  {#  $.ajax({#}
  {#    url: "/api/place/"+pid,#}
  {#    }).done(function( data ) {#}
  {#      console.log('getPlace() - why???', pid)#}
  {#      $("#result_extra").html(parsePlace(data))#}
  {#      // events on detail items#}
  {#      $('.ext').on('click', function(e) {#}
  {#        e.preventDefault();#}
  {#        str=$(this).text()#}
  {#        <!--console.log('str (identifier)',str)-->#}
  {#        // URL identifiers can be 'http*' or an authority prefix#}
  {#        if(str.substring(0,4).toLowerCase() == 'http'){#}
  {#          url = str#}
  {#        } else {#}
  {#          var re = /(http|bnf|cerl|dbp|gn|gnd|gov|loc|pl|tgn|viaf|wd|wdlocal|whg|wp):(.*?)$/;#}
  {#          url=base_urls[str.match(re)[1]]+str.match(re)[2]#}
  {#          console.log('url',url)#}
  {#        }#}
  {#        window.open(url, '_blank');#}
  {#      });#}
  {#      $('.exttab').on('click', function(e) {#}
  {#        e.preventDefault();#}
  {#        id=$(this).data('id')#}
  {#        console.log('id',id)#}
  {#        var re = /(http|dbp|gn|tgn|wd|loc|viaf|aat):(.*?)$/;#}
  {#        url=id.match(re)[1]=='http' ? id : base_urls[id.match(re)[1]]+id.match(re)[2]#}
  {#        console.log('url',url)#}
  {#        window.open(url,'_blank')#}
  {#      });#}
  {#  });#}
  {#  <!--spinner_detail.stop()-->#}
  {# }#}

  // map feature styles
  styles = {
    'marker_default': {
      radius:6,
      fillColor: "#ff0000",
      color:"#666",
      weight:1,
      fillOpacity:0.5,
      opacity:0.5},
    'marker_highlight': {
      radius:10,
      fillOpacity:1,
      fillColor:"yellow",
      color:"#000"
    },
    'line_default':{
      weight:3,
      opacity:1,
      color: "#00ccff"
    },
    'line_highlight':{weight: 4, color:"yellow"},
    'pgon_default':{
      fillColor: "#ff0000",
      color:"#fff",
      weight:2,
      fillOpacity:0.1,
      opacity:1},
    'pgon_highlight':{
      fillOpacity:1,fillColor:"yellow",color:"#000"
    }
  }

  /* _LISTENERS */
  /*
  // catch Enter key press for places
  // traces are handled in .typeahead function
  // disabled typeahead: removed class .typeahead from #input_box
  */
  $("#input_box").on('keyup', function(e){
    // resets page
    if($('#input_box').val().length < 3) {
      clearit()
    }
    doctype = 'place'
	  // on Enter
    if (e.keyCode === 13) {
      // always hide search_info
      $("#search_info").hide()
      if (searchScope() == 'idx'){
        searchPlacesIdx()
      } else {
        searchPlacesDb()
      }
      }
  })
  //
  $(".b-input").click(function(){
    doctype = 'place'
    {#doctype = $("input[name='class']:checked").val()#}
    if( searchScope() == 'idx'){
      searchPlacesIdx()
    } else { searchPlacesDb()}
  })
  //
  // hack: typeahead disabled for place
  // only valid if doctype has been changed
  $(".typeahead").on('keyup', function(e){
    <!--if($('#input_box').val().length < 3) {-->
      <!--clearit()-->
    <!--}-->
    doctype = 'place'
    {#doctype = $("input[name='class']:checked").val()#}
    if (e.keyCode === 13) {
      searchPlacesIdx()
    }
  })

  // acts on suggest items (.tt-selectable)
  $("#search_input").on('click','.tt-selectable', function(e) {
    if(doctype == 'place') {
      console.log('clicked place suggestion',$(this))
      searchPlacesIdx()
    }
  })

  // search scope tab actions
  $(".nav-link").click(function(){
    scope = $(this).data('scope')
    // TODO: avoid localStorage?
    localStorage.setItem('search_scope', scope)
    other = scope=='idx' ? $("#a_db") : $("#a_idx")

    // disappear stuff from last search
    $("#result_title").hide()
    $("#result_div").fadeOut()
    $("#result_filters").hide()
    $("#type_filter").hide()

    // simulate tab styling
    if(other.data('scope') == 'idx'){
      $("#search_filters").css("background","whitesmoke")
      $("#scope_db").css("border-bottom","1px solid whitesmoke")
      $("#filter_spatial").hide()
      $("#dbicon").fadeIn()
      $("#input_area").val('')
    } else {
      $("#search_filters").css("background","#f1fff1")
      $("#filter_spatial").show()
      $("#dbicon").hide()
    }
    other.removeClass('active')
    $(this).addClass('active')
  })
  // load place portal page from result_div item title links
  // TODO: links are nested so click produces 2 events
  $("#result_div").on('click', '.trace-link', function(e){
    whgid=$(this).data('id')
    console.log('whgid',whgid)
    location.href = '/places/'+whgid+'/portal'
  });
  // TODO handle db case
  $("#result_div").on('click', '.place-link', function(e){
    // set keep variable in localStorage
    localStorage.setItem('keep', true)
    localStorage.setItem('search_scope', searchScope())
    whgid=$(this).data('id')
    console.log('whgid',whgid)
	  // TODO: can't make spinner stop on window back
    {#window.spinner = new Spin.Spinner().spin();#}
    {#$("#map_search").append(spinner.el);#}
    location.href = '/places/'+whgid+'/portal'
  });
  $("#result_div").on('click', '.ds-link', function(e){
    dsid=$(this).data('id')
    console.log('dsid',dsid)
    window.open('/datasets/'+dsid, '_blank')
  });
  // public place detail page
  $("#result_div").on('click', '.db-link', function(e){
    localStorage.setItem('keep', true)
    localStorage.setItem('search_scope', searchScope())
    pid=$(this).data('id')
    console.log('pid', pid)
    window.spinner = new Spin.Spinner().spin();
    $("#map_search").append(spinner.el);
    location.href = '/places/'+pid+'/detail'
  });
  $('label.btn').click(function(){
    $(".autosuggest").html('')
    $('#search_input').val('')
    $('#search_input').attr("placeholder",this.getAttribute("rel"));
  })
  // radio button switch btwn place & trace search inputs
  $('input[type=radio][name=class]').change(function() {
    console.log('changed class', $(this).val())
    if ($(this).val() == 'place'){
      search_class = 'place'
      if(!$("#search_info").is(":visible")){
        $("#search_info").fadeIn()
        $("#scope_tabs").show()
      }
      $("#traces_info").hide()
      $("#filters_opener").show()
      $("#search_input").show()
      $("#search_filters").fadeIn()
      $("#search_input_traces").hide()
    } else { //
      search_class = 'trace'
      $("#search_info").fadeOut(400)
      if(!$("#traces_info").is(":visible")){
        $("#traces_info").show()
      }
      $("#scope_tabs").hide()
      $("#filters_opener").hide()
      $("#search_input").hide()
      $("#result_filters").hide()
      $("#search_filters").hide()
      // then show stuff
      $("#search_input_traces").show()
      $('.nav-pills a[href="#pills-why"]').tab('show')
    }

    $('#input_box').val('')
    $('#input_box').attr("placeholder",this.getAttribute("rel"));
    clearit()
  });
  // dataset dropdown
  <!--$("#select_ds_search").change(function(){-->
    <!--console.log('ds chosen', $(this).val())-->
  <!--})-->
  // radio $("#checkbox_div input:radio").click(function() {
  $(".filters-title input:radio").click(function(){
    t = $(this)
    console.log('clicked', $(this).val())
    if($(this).val() == 'idx'){
      $("#div_ds_select").hide()
    } else {
      $("#div_ds_select").show()
    }
  })

  /* UTILITY FUNCTIONS */
  // restores page w/o refresh
  clearit = function(){
    <!--console.log('clearit() called by',clearit.caller)-->
    $("#search_input").val('')
    $("#result_div").html('')
    $("#result_div").hide()
    $("#result_title").hide()
    $("#result_filters").hide()
    $("#type_filter").hide()
    $(".list-inline").html('')
    if(typeof(traces) !== "undefined") {traces.clearLayers(); mappy.setView([38, 10], 0)}
    if(features) {features.clearLayers(); mappy.setView([38, 10], 0)}
  }

  objLength = function(obj){
    return Object.keys(obj).length
  }
  spin_opts = { scale: .8, top: '70%', 'right':'30%'}
  startSearchSpinner = function(){
    window.spinner_search = new Spin.Spinner(spin_opts).spin();
    $("#search_filters").append(spinner_search.el);
  }
  {#switchTab = function(scope){#}
  {#  if(scope == 'db'){#}
  {#    $("#scope_idx").removeClass('active')#}
  {#    $("#scope_db").addClass('active')#}
  {#    $("#search_filters").css("background","whitesmoke")#}
  {#    $("#scope_db").css("border-bottom","1px solid whitesmoke")#}
  {#    $("#dbicon").fadeIn()#}
  {#    $("#filter_spatial").hide()#}
  {#    $("#input_area").val('')#}
  {#  } else {#}
  {#    $("#scope_db").removeClass('active')#}
  {#    $("#scope_idx").addClass('active')#}
  {#    $("#search_filters").css("background","#f1fff1")#}
  {#    $("#dbicon").hide()#}
  {#    $("#filter_spatial").show()#}
  {#  }#}
  {# }#}
  resetSearch = function(){
    localStorage.removeItem('last_results')
    localStorage.setItem('search_scope', 'idx')
    localStorage.removeItem('keep')
    $("#offer_mapfilter").hide()
    location.reload()
  }
</script>
{% endblock %}
